<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-buy { color: #28a745; }
        .signal-sell { color: #dc3545; }
        .signal-hold { color: #6c757d; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .chart-container { position: relative; height: 300px; }
        .signal-card { border-left: 4px solid #dee2e6; }
        .signal-card.buy { border-left-color: #28a745; }
        .signal-card.sell { border-left-color: #dc3545; }
        .signal-card.hold { border-left-color: #6c757d; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up"></i> Trading Agent Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="status-indicator" class="status-indicator status-running"></span>
                    <span id="status-text">Running</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Status</h5>
                        <h3 id="agent-status" class="text-success">Running</h3>
                        <small class="text-muted">Agent Status</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Signals</h5>
                        <h3 id="total-signals" class="text-primary">0</h3>
                        <small class="text-muted">Total Generated</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Symbols</h5>
                        <h3 id="active-symbols" class="text-info">0</h3>
                        <small class="text-muted">Active Trading</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Uptime</h5>
                        <h3 id="uptime" class="text-warning">0:00:00</h3>
                        <small class="text-muted">Agent Uptime</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Signal Generation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Generate Trading Signal</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="symbol-input" class="form-label">Symbol</label>
                                    <select class="form-select" id="symbol-input">
                                        <option value="">Loading symbols...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timeframe-input" class="form-label">Timeframe</label>
                                    <select class="form-select" id="timeframe-input">
                                        <option value="15m">15 minutes</option>
                                        <option value="1h" selected>1 hour</option>
                                        <option value="4h">4 hours</option>
                                        <option value="1d">1 day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Thresholds Section -->
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-2"></i>
                                <div>
                                    <strong>Custom Thresholds:</strong> Set your own signal generation parameters or leave empty to use system defaults.
                                    <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#thresholds-help">
                                        <i class="bi bi-question-circle"></i> Learn More
                                    </button>
                                </div>
                            </div>
                            <div class="collapse mt-2" id="thresholds-help">
                                <div class="card card-body bg-light">
                                    <small>
                                        <strong>Buy/Sell Thresholds:</strong> Range -1 to +1. Higher buy threshold = more selective buy signals. Lower sell threshold = more selective sell signals.<br>
                                        <strong>Weights:</strong> Range 0 to 1. Tech weight + sentiment weight should equal 1.0 for best results.<br>
                                        <strong>Defaults:</strong> Buy: 0.5, Sell: -0.5, Tech: 0.6, Sentiment: 0.4
                                    </small>
                                    
                                    <hr class="my-2">
                                    
                                    <div class="mt-2">
                                        <strong>üìä How Technical Weight & Sentiment Weight Work:</strong>
                                        <div class="mt-2">
                                            <strong>Technical Analysis (60% default):</strong>
                                            <ul class="mb-2">
                                                <li><strong>RSI Score:</strong> (RSI - 50) / 50 ‚Üí Range: -1 to +1</li>
                                                <li><strong>MACD Score:</strong> MACD Histogram / 1000 ‚Üí Range: -1 to +1</li>
                                                <li><strong>Combined:</strong> (RSI Score + MACD Score) / 2</li>
                                            </ul>
                                            
                                            <strong>Sentiment Analysis (40% default):</strong>
                                            <ul class="mb-2">
                                                <li><strong>News Headlines:</strong> Analyzed using FinBERT model</li>
                                                <li><strong>Sentiment Score:</strong> -1 (negative) to +1 (positive)</li>
                                                <li><strong>Source:</strong> Google News RSS feeds (stock market + crypto)</li>
                                            </ul>
                                            
                                            <strong>üéØ Final Signal Calculation:</strong>
                                            <div class="bg-white p-2 rounded border">
                                                <code>Fused Score = (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score)</code>
                                            </div>
                                            
                                            <div class="mt-2">
                                                <strong>Example:</strong><br>
                                                Tech Score: -0.19, Sentiment Score: 0.00<br>
                                                Tech Weight: 0.6, Sentiment Weight: 0.4<br>
                                                <code>Fused = (0.6 √ó -0.19) + (0.4 √ó 0.00) = -0.114 + 0.000 = -0.114</code>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="buy-threshold-input" class="form-label">Buy Threshold</label>
                                    <input type="number" class="form-control" id="buy-threshold-input" 
                                           placeholder="0.5" step="0.1" min="-1" max="1" 
                                           title="Buy signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.5)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sell-threshold-input" class="form-label">Sell Threshold</label>
                                    <input type="number" class="form-control" id="sell-threshold-input" 
                                           placeholder="-0.5" step="0.1" min="-1" max="1" 
                                           title="Sell signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (-0.5)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tech-weight-input" class="form-label">Technical Weight</label>
                                    <input type="number" class="form-control" id="tech-weight-input" 
                                           placeholder="0.6" step="0.1" min="0" max="1" 
                                           title="Weight for technical analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.6)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sentiment-weight-input" class="form-label">Sentiment Weight</label>
                                    <input type="number" class="form-control" id="sentiment-weight-input" 
                                           placeholder="0.4" step="0.1" min="0" max="1" 
                                           title="Weight for sentiment analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.4)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="generateSignal()">
                                <i class="bi bi-play-circle"></i> Generate Signal
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetThresholds()">
                                <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Signals -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Recent Signals</h5>
                    </div>
                    <div class="card-body">
                        <div id="signals-container">
                            <!-- Signals will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Market Data Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Market Data</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="changeTimeframe('15m')">15m</button>
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('1h')">1h</button>
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('4h')">4h</button>
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('1d')">1d</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Phase 1: Price Summary Cards -->
                        <div class="row mb-3">
                            <div class="col-12 d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Live Price Overview</h6>
                                <small class="text-muted">Last update: <span id="last-market-update">-</span></small>
                            </div>
                            <div class="row" id="price-summary-cards">
                                <!-- Price cards will be populated here -->
                            </div>
                        </div>
                        

                        
                        <!-- Phase 3: Market Statistics -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Performance Ranking</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="performance-ranking">
                                            <!-- Performance data will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-activity"></i> Market Statistics</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="market-statistics">
                                            <!-- Market stats will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div id="config-container">
                            <!-- Configuration will be populated here -->
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshConfig()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success" onclick="runBacktest()">
                                <i class="bi bi-graph-up-arrow"></i> Run Backtest
                            </button>
                            <button class="btn btn-outline-info" onclick="runTune()">
                                <i class="bi bi-tools"></i> Auto-Tune
                            </button>
                            <button class="btn btn-outline-warning" onclick="runSchedule()">
                                <i class="bi bi-clock"></i> Start Scheduler
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Info -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> System Info</h5>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <div>Version: 1.0.0</div>
                            <div>Last Update: <span id="last-update">-</span></div>
                            <div>API Status: <span id="api-status" class="text-success">Healthy</span></div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Modal -->
    <div class="modal fade" id="signalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Trading Signal Generated</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="signal-modal-body">
                    <!-- Signal details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let statusUpdateInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startStatusUpdates();
        });

        async function initializeDashboard() {
            await Promise.all([
                updateStatus(),
                loadSignals(),
                loadConfig(),
                loadMarketData()
            ]);
        }

        function startStatusUpdates() {
            statusUpdateInterval = setInterval(updateStatus, 5000); // Update every 5 seconds
            startMarketDataUpdates(); // Start market data updates
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                // Update status indicators
                document.getElementById('agent-status').textContent = status.status;
                document.getElementById('total-signals').textContent = status.total_signals;
                document.getElementById('active-symbols').textContent = status.active_symbols.length;
                document.getElementById('uptime').textContent = status.uptime;
                document.getElementById('last-update').textContent = new Date(status.last_update).toLocaleString();
                
                // Update status indicator
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                indicator.className = `status-indicator status-${status.status}`;
                statusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
                
            } catch (error) {
                console.error('Error updating status:', error);
                document.getElementById('api-status').textContent = 'Error';
                document.getElementById('api-status').className = 'text-danger';
            }
        }

        async function loadSignals() {
            try {
                const response = await fetch('/api/signals');
                const signals = await response.json();
                displaySignals(signals);
            } catch (error) {
                console.error('Error loading signals:', error);
            }
        }

        function displaySignals(signals) {
            const container = document.getElementById('signals-container');
            
            if (signals.length === 0) {
                container.innerHTML = '<p class="text-muted">No signals generated yet.</p>';
                return;
            }
            
            // Add compact header row
            let headerRow = `
                <div class="card mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body py-1">
                        <div class="row align-items-center text-center">
                            <div class="col-1">
                                <strong class="small text-white">#</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Type</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Symbol</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">TF</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Confidence</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Score</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Actions</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = headerRow + signals.map((signal, index) => `
                <div class="card signal-card ${signal.signal_type.toLowerCase()} mb-2 border-${getSignalColor(signal.signal_type)} border-1 shadow-sm">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-1 text-center">
                                <span class="badge bg-secondary rounded-circle small">${index + 1}</span>
                            </div>
                            <div class="col-2 text-center">
                                <span class="badge bg-${getSignalColor(signal.signal_type)} text-white small px-2 py-1">${signal.signal_type}</span>
                            </div>
                            <div class="col-2 text-center">
                                <strong class="small text-dark">${signal.symbol}</strong>
                            </div>
                            <div class="col-1 text-center">
                                <span class="badge bg-info text-white small">${signal.timeframe || '1h'}</span>
                            </div>
                            <div class="col-2 text-center">
                                <div class="d-flex flex-column align-items-center">
                                    <small class="text-muted">${(signal.confidence * 100).toFixed(1)}%</small>
                                    <div class="progress" style="width: 40px; height: 6px;">
                                        <div class="progress-bar bg-${getConfidenceColor(signal.confidence)}" 
                                             style="width: ${(signal.confidence * 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 text-center">
                                <span class="badge bg-${getScoreBadgeColor(signal.fused_score)} text-white small px-2 py-1">
                                    ${signal.fused_score.toFixed(2)}
                                </span>
                            </div>
                            <div class="col-2 text-center">
                                <button class="btn btn-sm btn-outline-${getSignalColor(signal.signal_type)} small" onclick="toggleSignalDetails('${signal.timestamp}')">
                                    <i class="bi bi-chevron-down" id="icon-${signal.timestamp}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2 bg-light" id="details-${signal.timestamp}" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-2 border-bottom pb-1 small">üìä Signal Configuration</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Technical Score</small><br>
                                        <strong>${signal.technical_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Sentiment Score</small><br>
                                        <strong>${signal.sentiment_score.toFixed(4)}</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4">
                                        <small class="text-muted">Fused Score</small><br>
                                        <strong>${signal.fused_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Confidence</small><br>
                                        <strong>${(signal.confidence * 100).toFixed(2)}%</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Timeframe</small><br>
                                        <strong class="text-info">${signal.timeframe || '1h'}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-2 border-bottom pb-1 small">üõ°Ô∏è Risk Management</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Stop Loss</small><br>
                                        <strong>${signal.stop_loss ? signal.stop_loss.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Take Profit</small><br>
                                        <strong>${signal.take_profit ? signal.take_profit.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Reasoning</small><br>
                                        <strong class="text-info">${signal.reasoning}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h6 class="text-warning mb-2 border-bottom pb-1 small">‚è∞ Timing & Context</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Generated At</small><br>
                                        <strong>${new Date(signal.timestamp).toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Signal ID</small><br>
                                        <strong class="text-muted">${signal.timestamp.split('T')[1].split('.')[0]}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-danger mb-2">Active Configuration</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">Buy Threshold</small><br>
                                        <strong class="text-success">‚â• 0.5</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sell Threshold</small><br>
                                        <strong class="text-danger">‚â§ -0.5</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Tech Weight</small><br>
                                        <strong class="text-primary">60%</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sentiment Weight</small><br>
                                        <strong class="text-info">40%</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Signal Logic</small><br>
                                        <strong class="text-secondary">
                                            ${signal.signal_type === 'BUY' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â• Buy Threshold (0.5)` :
                                                signal.signal_type === 'SELL' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â§ Sell Threshold (-0.5)` :
                                                `Fused Score (${signal.fused_score.toFixed(4)}) between thresholds (-0.5 to 0.5)`
                                            }
                                        </strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getSignalColor(signalType) {
            switch (signalType) {
                case 'BUY': return 'success';
                case 'SELL': return 'danger';
                case 'HOLD': return 'secondary';
                default: return 'secondary';
            }
        }
        
        function toggleSignalDetails(timestamp) {
            const detailsDiv = document.getElementById(`details-${timestamp}`);
            const icon = document.getElementById(`icon-${timestamp}`);
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.className = 'bi bi-chevron-up';
            } else {
                detailsDiv.style.display = 'none';
                icon.className = 'bi bi-chevron-down';
            }
        }
        
        function getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'success';
            if (confidence >= 0.6) return 'warning';
            if (confidence >= 0.4) return 'info';
            return 'danger';
        }
        
        function getScoreColor(score) {
            if (score >= 0.5) return 'success';
            if (score >= 0.0) return 'warning';
            if (score >= -0.5) return 'info';
            return 'danger';
        }
        
        function getScoreBadgeColor(score) {
            if (score >= 0.5) return 'success';
            if (score >= 0.0) return 'warning';
            if (score >= -0.5) return 'secondary';
            return 'danger';
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                displayConfig(config);
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        function displayConfig(config) {
            const container = document.getElementById('config-container');
            container.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">Tickers</small><br>
                    <strong>${config.tickers.join(', ')}</strong>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Timeframe</small><br>
                    <strong>${config.timeframe}</strong>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Buy Threshold</small><br>
                    <strong>${config.buy_threshold}</strong>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Sell Threshold</small><br>
                    <strong>${config.sell_threshold}</strong>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Tech Weight</small><br>
                    <strong>${config.tech_weight}</strong>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Sentiment Weight</small><br>
                    <strong>${config.sentiment_weight}</strong>
                </div>
            `;
            
            // Populate symbol dropdown
            populateSymbolDropdown(config.tickers);
        }
        
        function populateSymbolDropdown(symbols) {
            const symbolSelect = document.getElementById('symbol-input');
            symbolSelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a symbol...';
            symbolSelect.appendChild(defaultOption);
            
            // Add symbols from config
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolSelect.appendChild(option);
            });
            
            // Set first symbol as default if available
            if (symbols.length > 0) {
                symbolSelect.value = symbols[0];
            }
        }

        async function generateSignal() {
            const symbol = document.getElementById('symbol-input').value;
            const timeframe = document.getElementById('timeframe-input').value;
            
            if (!symbol) {
                alert('Please select a symbol from the dropdown');
                return;
            }
            
            // Get custom threshold values (empty strings become null for backend)
            const buyThreshold = document.getElementById('buy-threshold-input').value;
            const sellThreshold = document.getElementById('sell-threshold-input').value;
            const techWeight = document.getElementById('tech-weight-input').value;
            const sentimentWeight = document.getElementById('sentiment-weight-input').value;
            
            // Prepare request payload
            const payload = {
                symbol,
                timeframe,
                custom_buy_threshold: buyThreshold === '' ? null : parseFloat(buyThreshold),
                custom_sell_threshold: sellThreshold === '' ? null : parseFloat(sellThreshold),
                custom_tech_weight: techWeight === '' ? null : parseFloat(techWeight),
                custom_sentiment_weight: sentimentWeight === '' ? null : parseFloat(sentimentWeight)
            };
            
            try {
                const response = await fetch('/api/signals/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const signal = await response.json();
                    showSignalModal(signal);
                    await loadSignals(); // Refresh signals list
                    await updateStatus(); // Update status
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error generating signal:', error);
                alert('Error generating signal. Please try again.');
            }
        }

        function resetThresholds() {
            // Reset all threshold inputs to empty (will use defaults)
            document.getElementById('buy-threshold-input').value = '';
            document.getElementById('sell-threshold-input').value = '';
            document.getElementById('tech-weight-input').value = '';
            document.getElementById('sentiment-weight-input').value = '';
            
            // Show feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i> Reset!';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        }

        function showSignalModal(signal) {
            const modalBody = document.getElementById('signal-modal-body');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Signal Details</h6>
                        <p><strong>Symbol:</strong> ${signal.symbol}</p>
                        <p><strong>Type:</strong> <span class="badge bg-${getSignalColor(signal.signal_type)}">${signal.signal_type}</span></p>
                        <p><strong>Confidence:</strong> ${(signal.confidence * 100).toFixed(1)}%</p>
                        <p><strong>Timestamp:</strong> ${new Date(signal.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Scores</h6>
                        <p><strong>Technical:</strong> ${signal.technical_score.toFixed(2)}</p>
                        <p><strong>Sentiment:</strong> ${signal.sentiment_score.toFixed(2)}</p>
                        <p><strong>Fused:</strong> ${signal.fused_score.toFixed(2)}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Risk Management</h6>
                        ${signal.stop_loss ? `<p><strong>Stop Loss:</strong> ${signal.stop_loss.toFixed(2)}</p>` : ''}
                        ${signal.take_profit ? `<p><strong>Take Profit:</strong> ${signal.take_profit.toFixed(2)}</p>` : ''}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Reasoning</h6>
                        <p>${signal.reasoning}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('signalModal'));
            modal.show();
        }

        async function refreshConfig() {
            await loadConfig();
        }

        function runBacktest() {
            alert('Backtest functionality will be implemented in the CLI integration');
        }

        function runTune() {
            alert('Auto-tune functionality will be implemented in the CLI integration');
        }

        function runSchedule() {
            alert('Scheduler functionality will be implemented in the CLI integration');
        }

        // Market Data Functions
        
        let marketDataInterval = null;
        
        async function loadMarketData() {
            await Promise.all([
                loadPriceSummaryCards(),
                loadPerformanceRanking(),
                loadMarketStatistics()
            ]);
        }
        
        async function loadPriceSummaryCards() {
            try {
                // Use the new overview endpoint for real-time data with default timeframe
                const response = await fetch('/api/market-data/all/overview?timeframe=15m');
                if (!response.ok) {
                    throw new Error('Failed to fetch market overview');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('price-summary-cards');
                let cardsHTML = '';
                
                marketData.symbols.forEach(symbolData => {
                    if (symbolData.error) {
                        // Error card
                        cardsHTML += `
                            <div class="col-md-4 mb-2">
                                <div class="card h-100 border-warning">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1">${symbolData.symbol}</h6>
                                        <p class="text-warning mb-0">${symbolData.error}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const isPositive = symbolData.change >= 0;
                        const priceColor = isPositive ? 'success' : 'danger';
                        
                        cardsHTML += `
                            <div class="col-md-4 mb-2">
                                <div class="card h-100 ${isPositive ? 'border-success' : 'border-danger'} shadow-sm">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${symbolData.symbol}</h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="h5 mb-0">$${symbolData.current_price.toFixed(2)}</span>
                                                    <span class="ms-2 badge bg-${priceColor}">
                                                        ${isPositive ? '+' : ''}${symbolData.change_percent.toFixed(2)}%
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    H: $${symbolData.high.toFixed(2)} | L: $${symbolData.low.toFixed(2)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <i class="bi bi-arrow-${isPositive ? 'up' : 'down'}-right text-${priceColor} fs-4"></i>
                                                <div class="mt-1">
                                                    <small class="text-muted">Vol: ${symbolData.volume.toLocaleString()}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.innerHTML = cardsHTML;
                
                // Update last refresh time
                const lastUpdate = new Date(marketData.timestamp).toLocaleTimeString();
                document.getElementById('last-market-update').textContent = lastUpdate;
                
            } catch (error) {
                console.error('Error loading price summary cards:', error);
                const container = document.getElementById('price-summary-cards');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Error loading market data: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        
        async function loadPerformanceRanking() {
            try {
                // Use the overview endpoint for real performance data
                const response = await fetch('/api/market-data/all/overview');
                if (!response.ok) {
                    throw new Error('Failed to fetch performance data');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('performance-ranking');
                let rankingHTML = '';
                
                // Sort by performance
                const performances = marketData.symbols
                    .filter(s => !s.error)
                    .sort((a, b) => b.change_percent - a.change_percent);
                
                performances.forEach((perf, index) => {
                    const isPositive = perf.change_percent >= 0;
                    const rankClass = index === 0 ? 'text-warning' : index === 1 ? 'text-secondary' : index === 2 ? 'text-bronze' : '';
                    
                    rankingHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${index + 1}</span>
                                <span class="${rankClass}">${perf.symbol}</span>
                            </div>
                            <span class="badge bg-${isPositive ? 'success' : 'danger'}">
                                ${isPositive ? '+' : ''}${perf.change_percent.toFixed(2)}%
                            </span>
                        </div>
                    `;
                });
                
                container.innerHTML = rankingHTML || '<p class="text-muted">No performance data available</p>';
            } catch (error) {
                console.error('Error loading performance ranking:', error);
                const container = document.getElementById('performance-ranking');
                container.innerHTML = '<p class="text-warning">Error loading performance data</p>';
            }
        }
        
        async function loadMarketStatistics() {
            try {
                // Use the overview endpoint for real statistics
                const response = await fetch('/api/market-data/all/overview');
                if (!response.ok) {
                    throw new Error('Failed to fetch market statistics');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('market-statistics');
                let statsHTML = '';
                
                // Calculate statistics from real data
                const validSymbols = marketData.symbols.filter(s => !s.error);
                const totalVolume = validSymbols.reduce((sum, s) => sum + s.volume, 0);
                const totalChange = validSymbols.reduce((sum, s) => sum + s.change_percent, 0);
                const symbolCount = validSymbols.length;
                
                const avgChange = symbolCount > 0 ? totalChange / symbolCount : 0;
                const marketSentiment = avgChange > 1 ? 'Bullish' : avgChange < -1 ? 'Bearish' : 'Neutral';
                const sentimentColor = avgChange > 1 ? 'success' : avgChange < -1 ? 'danger' : 'warning';
                
                // Calculate additional metrics
                const upSymbols = validSymbols.filter(s => s.change_percent > 0).length;
                const downSymbols = validSymbols.filter(s => s.change_percent < 0).length;
                const flatSymbols = validSymbols.filter(s => s.change_percent === 0).length;
                
                statsHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Market Sentiment</h6>
                                <span class="badge bg-${sentimentColor} fs-6">${marketSentiment}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Avg Change</h6>
                                <span class="badge bg-${avgChange >= 0 ? 'success' : 'danger'} fs-6">
                                    ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <div class="text-center mb-2">
                                <h6 class="text-muted">Symbol Performance</h6>
                                <div class="d-flex justify-content-around">
                                    <span class="badge bg-success">${upSymbols} Up</span>
                                    <span class="badge bg-danger">${downSymbols} Down</span>
                                    <span class="badge bg-secondary">${flatSymbols} Flat</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Active Symbols:</strong> ${symbolCount}<br>
                                <strong>Total Volume:</strong> ${totalVolume.toLocaleString()}<br>
                                <strong>Data Source:</strong> Live Market Data<br>
                                <strong>Last Update:</strong> ${new Date(marketData.timestamp).toLocaleTimeString()}
                            </small>
                        </div>
                    </div>
                `;
                
                container.innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading market statistics:', error);
                const container = document.getElementById('market-statistics');
                container.innerHTML = '<p class="text-warning">Error loading market statistics</p>';
            }
        }
        

        
        // Start market data updates
        function startMarketDataUpdates() {
            marketDataInterval = setInterval(loadMarketData, 30000); // Update every 30 seconds
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            if (marketDataInterval) {
                clearInterval(marketDataInterval);
            }
        });
    </script>
</body>
</html>

