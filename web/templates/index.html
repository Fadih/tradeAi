<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-buy { color: #28a745; }
        .signal-sell { color: #dc3545; }
        .signal-hold { color: #6c757d; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .chart-container { position: relative; height: 300px; }
        .signal-card { border-left: 4px solid #dee2e6; }
        .signal-card.buy { border-left-color: #28a745; }
        .signal-card.sell { border-left-color: #dc3545; }
        .signal-card.hold { border-left-color: #6c757d; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow me-2"></i> Trading AI Tips
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <span id="status-indicator" class="status-indicator status-running"></span>
                    <span id="status-text">Running</span>
                </span>
                
                <!-- User Profile Dropdown -->
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-1"></i>
                        <span id="user-username">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><h6 class="dropdown-header">User Profile</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="showUserProfile()">
                            <i class="bi bi-person me-2"></i>View Profile
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="showChangePassword()">
                            <i class="bi bi-key me-2"></i>Change Password
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Trading Tips</h5>
                        <h3 id="total-signals" class="text-primary">0</h3>
                        <small class="text-muted">Total Generated</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Markets</h5>
                        <h3 id="active-symbols" class="text-info">0</h3>
                        <small class="text-muted">Active Trading</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Main Column -->
            <div class="col-12">
                <!-- Trading Tip Generation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Generate Trading Tip</h5>
                    </div>
                    <div class="card-body">
                        <!-- Custom Thresholds Section -->
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-2"></i>
                                <div>
                                    <strong>Custom Thresholds:</strong> Set your own signal generation parameters or leave empty to use system defaults.
                                    <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#thresholds-help">
                                        <i class="bi bi-question-circle"></i> Learn More
                                    </button>
                                </div>
                            </div>
                            <div class="collapse mt-2" id="thresholds-help">
                                <div class="card card-body bg-light">
                                    <h6 class="text-primary mb-3">üéì Trading Terms Explained</h6>
                                    
                                    <!-- Technical Indicators -->
                                    <div class="mb-4">
                                        <h6 class="text-success">üìà Technical Indicators</h6>
                                        
                                        <div class="mb-3">
                                            <strong>RSI (Relative Strength Index)</strong>
                                            <p class="mb-1"><small class="text-muted">Measures if a market is overbought or oversold</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>Range:</strong> 0 to 100</li>
                                                <li><strong>Overbought:</strong> RSI > 70 (market might fall)</li>
                                                <li><strong>Oversold:</strong> RSI < 30 (market might rise)</li>
                                                <li><strong>Our Score:</strong> (RSI - 50) √∑ 50 ‚Üí Range: -1 to +1</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>MACD (Moving Average Convergence Divergence)</strong>
                                            <p class="mb-1"><small class="text-muted">Shows trend changes and momentum</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>What it shows:</strong> When short-term trend crosses long-term trend</li>
                                                <li><strong>Positive:</strong> Upward momentum (bullish)</li>
                                                <li><strong>Negative:</strong> Downward momentum (bearish)</li>
                                                <li><strong>Our Score:</strong> MACD Histogram √∑ 1000 ‚Üí Range: -1 to +1</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>ATR (Average True Range)</strong>
                                            <p class="mb-1"><small class="text-muted">Measures market volatility for stop-loss and take-profit</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>High ATR:</strong> Market is volatile (wider stops needed)</li>
                                                <li><strong>Low ATR:</strong> Market is calm (tighter stops possible)</li>
                                                <li><strong>Used for:</strong> Stop Loss = 2√óATR, Take Profit = 3√óATR</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Sentiment Analysis -->
                                    <div class="mb-4">
                                        <h6 class="text-info">üì∞ Sentiment Analysis</h6>
                                        <div class="mb-3">
                                            <strong>FinBERT Model</strong>
                                            <p class="mb-1"><small class="text-muted">AI that reads news headlines and determines market sentiment</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>Positive News:</strong> +1 (bullish sentiment)</li>
                                                <li><strong>Negative News:</strong> -1 (bearish sentiment)</li>
                                                <li><strong>Neutral News:</strong> 0 (no clear direction)</li>
                                                <li><strong>Sources:</strong> Google News RSS feeds for stocks and crypto</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Signal Generation -->
                                    <div class="mb-4">
                                        <h6 class="text-warning">üéØ How Signals Are Generated</h6>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Step 1: Calculate Technical Score</strong><br>
                                            <code class="small">Technical Score = (RSI Score + MACD Score) √∑ 2</code><br><br>
                                            
                                            <strong>Step 2: Get Sentiment Score</strong><br>
                                            <code class="small">Sentiment Score = FinBERT analysis of news headlines</code><br><br>
                                            
                                            <strong>Step 3: Combine with Weights</strong><br>
                                            <code class="small">Final Score = (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score)</code><br><br>
                                            
                                            <strong>Step 4: Generate Signal</strong><br>
                                            <ul class="small mb-0">
                                                <li><strong>BUY:</strong> Final Score ‚â• Buy Threshold (e.g., 0.5)</li>
                                                <li><strong>SELL:</strong> Final Score ‚â§ Sell Threshold (e.g., -0.5)</li>
                                                <li><strong>HOLD:</strong> Final Score between thresholds</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Example -->
                                    <div class="mb-3">
                                        <h6 class="text-secondary">üí° Real Example</h6>
                                        <div class="bg-light p-3 rounded">
                                            <strong>Market:</strong> BTC/USDT<br>
                                            <strong>RSI:</strong> 45 ‚Üí Score: (45-50)√∑50 = -0.1<br>
                                            <strong>MACD:</strong> -0.5 ‚Üí Score: -0.5√∑1000 = -0.0005<br>
                                            <strong>Technical Score:</strong> (-0.1 + -0.0005) √∑ 2 = -0.05<br>
                                            <strong>Sentiment:</strong> -0.2 (negative news)<br>
                                            <strong>Weights:</strong> Tech 60%, Sentiment 40%<br>
                                            <strong>Final Score:</strong> (0.6 √ó -0.05) + (0.4 √ó -0.2) = -0.11<br>
                                            <strong>Result:</strong> HOLD (between -0.5 and +0.5)
                                        </div>
                                    </div>
                                    
                                    <!-- Thresholds -->
                                    <div class="mb-3">
                                        <h6 class="text-primary">‚öôÔ∏è Threshold Settings</h6>
                                        <ul class="small mb-2">
                                            <li><strong>Buy Threshold:</strong> How strong the signal must be to recommend buying</li>
                                            <li><strong>Sell Threshold:</strong> How negative the signal must be to recommend selling</li>
                                            <li><strong>Higher thresholds:</strong> Fewer but more reliable signals</li>
                                            <li><strong>Lower thresholds:</strong> More signals but less reliable</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="buy-threshold-input" class="form-label">
                                        Buy Threshold 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Minimum fused score for BUY signals. Range: 0.1-1.0. Higher = more conservative. Default: 0.5"></i>
                                    </label>
                                    <input type="number" class="form-control" id="buy-threshold-input" 
                                           placeholder="0.5" step="0.1" min="-1" max="1" 
                                           title="Buy signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.5)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sell-threshold-input" class="form-label">
                                        Sell Threshold 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Maximum fused score for SELL signals. Range: -1.0 to -0.1. More negative = more conservative. Default: -0.5"></i>
                                    </label>
                                    <input type="number" class="form-control" id="sell-threshold-input" 
                                           placeholder="-0.5" step="0.1" min="-1" max="1" 
                                           title="Sell signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (-0.5)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tech-weight-input" class="form-label">
                                        Technical Weight 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="How much technical indicators (RSI, MACD) influence the signal. Range: 0.0-1.0. Must add up to 1.0 with sentiment weight. Default: 0.6"></i>
                                    </label>
                                    <input type="number" class="form-control" id="tech-weight-input" 
                                           placeholder="0.6" step="0.1" min="0" max="1" 
                                           title="Weight for technical analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.6)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sentiment-weight-input" class="form-label">
                                        Sentiment Weight 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="How much news sentiment analysis influences the signal. Range: 0.0-1.0. Must add up to 1.0 with technical weight. Default: 0.4"></i>
                                    </label>
                                    <input type="number" class="form-control" id="sentiment-weight-input" 
                                           placeholder="0.4" step="0.1" min="0" max="1" 
                                           title="Weight for sentiment analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default (0.4)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> Technical Weight + Sentiment Weight must equal 1.0
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="symbol-input" class="form-label">Market</label>
                                    <select class="form-select" id="symbol-input">
                                        <option value="">Loading markets...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timeframe-input" class="form-label">Timeframe</label>
                                    <select class="form-select" id="timeframe-input">
                                        <option value="15m">15 minutes</option>
                                        <option value="1h" selected>1 hour</option>
                                        <option value="4h">4 hours</option>
                                        <option value="1d">1 day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="generateSignal()">
                                <i class="bi bi-play-circle"></i> Generate Trading Tip
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetThresholds()">
                                <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                            </button>
                        </div>

                    </div>
                </div>

                <!-- Recent Trading Tips -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Recent Trading Tips</h5>
                    </div>
                    <div class="card-body">
                        <div id="signals-container">
                            <!-- Signals will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Market Overview -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Market Overview</h5>
                        <small class="text-muted">Last updated: <span id="last-market-update">-</span></small>
                    </div>
                    <div class="card-body">
                        <div class="row" id="price-summary-cards">
                            <!-- Price cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Performance Ranking and Market Statistics -->
                <div class="row mb-4">
                    <!-- Performance Ranking -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-trophy"></i> Performance Ranking</h5>
                            </div>
                            <div class="card-body">
                                <div id="performance-ranking">
                                    <!-- Performance ranking will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Statistics -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Market Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div id="market-statistics">
                                    <!-- Market statistics will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Signal Modal -->
    <div class="modal fade" id="signalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Trading Tip Generated</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="signal-modal-body">
                    <!-- Signal details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Notification System -->
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
    
    <script>
        // Global variables
        let statusUpdateInterval = null;

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-info';
            
            notification.className = `alert ${bgClass} text-white border-0 shadow-sm mb-2`;
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 
                                     type === 'error' ? 'x-circle' : 
                                     type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close btn-close-white ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeDashboard();
            startStatusUpdates();
            
            // Initialize tooltips for form elements
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Cleanup intervals when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });

        // Authentication Functions
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const role = localStorage.getItem('user_role');
            
            if (!token || !role) {
                window.location.href = '/login';
                return;
            }
            
            // Update username display
            document.getElementById('user-username').textContent = localStorage.getItem('username') || 'User';
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');
            window.location.href = '/login';
        }

        async function initializeDashboard() {
            console.log('Starting initializeDashboard');
            // Show loading states
            showLoadingStates();
            
            try {
                console.log('Starting parallel API calls');
                // Parallelize all API calls for faster loading
                await Promise.all([
                    updateStatus(),
                    loadSignals(),
                    populateSymbolDropdown(), // Move this to parallel execution
                    loadMarketData()
                ]);
                console.log('All API calls completed successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            } finally {
                console.log('Hiding loading states');
                // Always hide loading states, even if some API calls failed
                hideLoadingStates();
            }
        }

        // Cache for symbol data to avoid repeated API calls
        let symbolCache = null;
        let symbolCacheTime = 0;
        const SYMBOL_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        async function populateSymbolDropdown() {
            console.log('Starting populateSymbolDropdown');
            const symbolSelect = document.getElementById('symbol-input');
            if (!symbolSelect) {
                console.error('Symbol select element not found');
                return;
            }
            
            symbolSelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a market...';
            symbolSelect.appendChild(defaultOption);
            
            try {
                console.log('Fetching symbols from API...');
                const response = await fetch('/api/config');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                const activeSymbols = config.tickers || [];
                
                console.log('Successfully fetched symbols:', activeSymbols);
                
                // Add symbols to dropdown
                activeSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                    symbolSelect.appendChild(option);
                });
                
                // Set first symbol as default
                if (activeSymbols.length > 0) {
                    symbolSelect.value = activeSymbols[0];
                }
                
                console.log('Symbols dropdown populated successfully');
                
            } catch (error) {
                console.error('Error fetching config:', error);
                
                // Fallback to default symbols
                console.log('Using fallback symbols due to error');
                const fallbackSymbols = ['BTC/USDT', 'ETH/USDT', 'SPY'];
                
                fallbackSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                    symbolSelect.appendChild(option);
                });
                
                if (fallbackSymbols.length > 0) {
                    symbolSelect.value = fallbackSymbols[0];
                }
                
                console.log('Fallback symbols added');
            }
        }

        function populateDropdownFromCache(cacheData) {
            const symbolSelect = document.getElementById('symbol-input');
            const { activeSymbols } = cacheData;
            
            // Add all symbols with indicators
            const allSymbols = ['BTC/USDT', 'ETH/USDT', 'SPY', 'AAPL', 'GOOGL', 'TSLA', 'MSFT', 'AMZN'];
            
            allSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                
                // Add indicator for actively configured symbols
                if (activeSymbols.includes(symbol)) {
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = `${symbol} ‚ö†Ô∏è (May need API setup)`;
                    option.style.color = '#6c757d';
                }
                
                symbolSelect.appendChild(option);
            });
            
            // Set first active symbol as default if available
            if (activeSymbols.length > 0) {
                symbolSelect.value = activeSymbols[0];
            }
            
            // Update the active symbols count display
            document.getElementById('active-symbols').textContent = activeSymbols.length;
            document.getElementById('active-symbols').className = 'text-info'; // Reset color
        }

        function populateFallbackSymbols() {
            const symbolSelect = document.getElementById('symbol-input');
            const fallbackSymbols = ['BTC/USDT', 'ETH/USDT', 'SPY'];
            
            fallbackSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = `${symbol} ‚úÖ (Active)`;
                option.style.fontWeight = 'bold';
                symbolSelect.appendChild(option);
            });
            
            symbolSelect.value = fallbackSymbols[0];
            
            // Don't override the active symbols count if it's already been set by status API
            const currentCount = document.getElementById('active-symbols').textContent;
            if (currentCount === '' || currentCount === '0' || currentCount.includes('hourglass')) {
                document.getElementById('active-symbols').textContent = fallbackSymbols.length;
                document.getElementById('active-symbols').className = 'text-info';
            }
        }

        function startStatusUpdates() {
            statusUpdateInterval = setInterval(updateStatus, 5000); // Update every 5 seconds
            // Delay market data updates to prioritize critical data
            setTimeout(() => {
                startMarketDataUpdates();
            }, 2000); // Start market data after 2 seconds
        }


        async function updateStatus() {
            try {
                // Get authentication token for user-specific status
                const token = localStorage.getItem('auth_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/status', { headers });
                const status = await response.json();
                
                // Update status indicators
                document.getElementById('total-signals').textContent = status.total_trading_tips;
                document.getElementById('active-symbols').textContent = status.active_symbols.length;
                
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function loadSignals() {
            try {
                console.log('Starting loadSignals function');
                // Get authentication token
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    console.error('No authentication token found');
                    displaySignals([]); // Show empty state
                    return;
                }
                console.log('Authentication token found, making API call');
                
                const response = await fetch('/api/signals', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const signals = await response.json();
                    console.log('Signals received:', signals.length, 'signals');
                    console.log('Signals data:', signals);
                    displaySignals(signals);
                } else if (response.status === 401) {
                    console.error('Authentication failed, redirecting to login');
                    window.location.href = '/login';
                } else {
                    console.error('Error loading signals:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    displaySignals([]); // Show empty state on error
                }
            } catch (error) {
                console.error('Error loading signals:', error);
                displaySignals([]); // Show empty state on error
            }
        }

        function displaySignals(signals) {
            console.log('displaySignals called with:', signals.length, 'signals');
            const container = document.getElementById('signals-container');
            console.log('Signals container found:', container);
            
            if (signals.length === 0) {
                console.log('No signals to display, showing empty message');
                container.innerHTML = '<p class="text-muted">No trading tips generated yet.</p>';
                return;
            }
            
            console.log('Displaying', signals.length, 'signals');
            
            // Add compact header row
            let headerRow = `
                <div class="card mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body py-1">
                        <div class="row align-items-center text-center">
                            <div class="col-1">
                                <strong class="small text-white">#</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">Type</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Market</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">TF</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Time Created</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">Confidence</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Score</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Actions</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = headerRow + signals.map((signal, index) => `
                <div class="card signal-card ${signal.signal_type.toLowerCase()} mb-2 border-${getSignalColor(signal.signal_type)} border-1 shadow-sm">

                    <div class="card-body py-2">
                        <div class="row align-items-center text-center">
                            <div class="col-1">
                                <span class="badge bg-secondary">${index + 1}</span>
                            </div>
                            <div class="col-1">
                                <span class="badge bg-${getSignalColor(signal.signal_type)}">${signal.signal_type}</span>
                            </div>
                            <div class="col-2">
                                <strong>${signal.symbol}</strong>
                            </div>
                            <div class="col-1">
                                <span class="badge bg-info">${signal.timeframe || '1h'}</span>
                            </div>
                            <div class="col-2">
                                <small class="text-muted">${formatTimestamp(signal.timestamp)}</small>
                            </div>
                            <div class="col-1">
                                <strong>${(signal.confidence * 100).toFixed(1)}%</strong>
                            </div>
                            <div class="col-2">
                                <span class="badge bg-${getScoreBadgeColor(signal.fused_score)} text-white small px-2 py-1">
                                    ${signal.fused_score.toFixed(2)}
                                </span>
                            </div>
                            <div class="col-2 text-center">
                                <button class="btn btn-sm btn-outline-${getSignalColor(signal.signal_type)} small me-1" onclick="toggleSignalDetails('${signal.timestamp}')">
                                    <i class="bi bi-chevron-down" id="icon-${signal.timestamp}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger small" onclick="deleteSignal('${signal.timestamp}', '${signal.symbol}')" title="Delete Signal">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2 bg-light" id="details-${signal.timestamp}" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-2 border-bottom pb-1 small">üìä Signal Configuration</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Technical Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Combines RSI and MACD indicators. Range: -1 to +1. Positive = bullish momentum, Negative = bearish momentum. Calculated as: (RSI_score + MACD_score) / 2"></i>
                                        </small><br>
                                        <strong>${signal.technical_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Sentiment Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="News sentiment analysis using FinBERT model. Range: -1 to +1. Positive = bullish news, Negative = bearish news. Based on recent market headlines from Google News RSS feeds."></i>
                                        </small><br>
                                        <strong>${signal.sentiment_score.toFixed(4)}</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4">
                                        <small class="text-muted">
                                            Fused Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Final signal score combining technical and sentiment analysis. Formula: (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score). Range: -1 to +1. Used to determine BUY/SELL/HOLD signals."></i>
                                        </small><br>
                                        <strong>${signal.fused_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">
                                            Confidence 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Signal strength indicator. Calculated as absolute value of fused score. Range: 0% to 100%. Higher values indicate stronger conviction in the signal direction."></i>
                                        </small><br>
                                        <strong>${(signal.confidence * 100).toFixed(2)}%</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Timeframe</small><br>
                                        <strong class="text-info">${signal.timeframe || '1h'}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-2 border-bottom pb-1 small">üõ°Ô∏è Risk Management</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Stop Loss 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Automatic exit price to limit losses. Calculated as: Current Price ¬± (2 √ó ATR). For BUY signals: Current Price - (2 √ó ATR). For SELL signals: Current Price + (2 √ó ATR). ATR = Average True Range (volatility measure)."></i>
                                        </small><br>
                                        <strong>${signal.stop_loss ? signal.stop_loss.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Take Profit 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Target profit exit price. Calculated as: Current Price ¬± (3 √ó ATR). For BUY signals: Current Price + (3 √ó ATR). For SELL signals: Current Price - (3 √ó ATR). Risk-reward ratio is 1:1.5 (2 ATR risk vs 3 ATR reward)."></i>
                                        </small><br>
                                        <strong>${signal.take_profit ? signal.take_profit.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Reasoning</small><br>
                                        <strong class="text-info">${signal.reasoning}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h6 class="text-warning mb-2 border-bottom pb-1 small">‚è∞ Timing & Context</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Generated At</small><br>
                                        <strong>${new Date(signal.timestamp).toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Signal ID</small><br>
                                        <strong class="text-muted">${signal.timestamp.split('T')[1].split('.')[0]}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-danger mb-2">Applied Thresholds</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">Buy Threshold</small><br>
                                        <strong class="text-success">‚â• ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : '0.50'}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sell Threshold</small><br>
                                        <strong class="text-danger">‚â§ ${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : '-0.50'}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Tech Weight</small><br>
                                        <strong class="text-primary">${signal.applied_tech_weight !== null ? (signal.applied_tech_weight * 100).toFixed(0) : '60'}%</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sentiment Weight</small><br>
                                        <strong class="text-info">${signal.applied_sentiment_weight !== null ? (signal.applied_sentiment_weight * 100).toFixed(0) : '40'}%</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Signal Logic</small><br>
                                        <strong class="text-secondary">
                                            ${signal.signal_type === 'BUY' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â• Buy Threshold (${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : '0.5'})` :
                                                signal.signal_type === 'SELL' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â§ Sell Threshold (${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : '-0.5'})` :
                                                `Fused Score (${signal.fused_score.toFixed(4)}) between thresholds (${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : '-0.5'} to ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : '0.5'})`
                                            }
                                            <br><small class="text-muted">Debug: buy=${signal.applied_buy_threshold}, sell=${signal.applied_sell_threshold}</small>
                                        </strong>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-info mb-2 border-bottom pb-1 small">üìà Signal History <small class="text-muted">(refreshes on expand)</small></h6>
                                <div id="history-${signal.timestamp}" class="signal-history">
                                    <div class="text-center py-2">
                                        <small class="text-muted">Click to expand and view history</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Initialize tooltips for all info icons
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function getSignalColor(signalType) {
            switch (signalType) {
                case 'BUY': return 'success';
                case 'SELL': return 'danger';
                case 'HOLD': return 'secondary';
                default: return 'secondary';
            }
        }
        
        function getScoreBadgeColor(score) {
            if (score >= 0.5) return 'success';
            if (score <= -0.5) return 'danger';
            return 'secondary';
        }

        function formatTimestamp(timestamp) {
            try {
                // Parse timestamp (should be in Israel timezone format)
                const date = new Date(timestamp);
                
                // Get current time in Israel timezone
                const now = new Date();
                const israelNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
                const israelDate = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
                
                const diffMs = israelNow - israelDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'Just now';
                } else if (diffMins < 60) {
                    return `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    return `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    return `${diffDays}d ago`;
                } else {
                    // For older dates, show formatted date in Israel timezone
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Jerusalem'
                    });
                }
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return 'Unknown';
            }
        }
        
        function toggleSignalDetails(timestamp) {
            const detailsElement = document.getElementById(`details-${timestamp}`);
            const iconElement = document.getElementById(`icon-${timestamp}`);
            
            if (detailsElement && iconElement) {
                if (detailsElement.style.display === 'none') {
                    detailsElement.style.display = 'block';
                    iconElement.className = 'bi bi-chevron-up';
                    // Always refresh signal history when expanding
                    refreshSignalHistory(timestamp);
                } else {
                    detailsElement.style.display = 'none';
                    iconElement.className = 'bi bi-chevron-down';
                }
            }
        }

        async function deleteSignal(timestamp, symbol) {
            if (!confirm(`Are you sure you want to delete the signal for ${symbol}?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Authentication required. Please login again.', 'error');
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch(`/api/signals/${timestamp}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Signal deleted successfully!', 'success');
                    await loadSignals(); // Refresh the signals list
                } else {
                    const error = await response.json();
                    showNotification(`Failed to delete signal: ${error.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting signal:', error);
                showNotification('Failed to delete signal. Please try again.', 'error');
            }
        }

        function resetThresholds() {
            // Reset all threshold input fields to empty
            document.getElementById('buy-threshold-input').value = '';
            document.getElementById('sell-threshold-input').value = '';
            document.getElementById('tech-weight-input').value = '';
            document.getElementById('sentiment-weight-input').value = '';
            
            showNotification('Thresholds reset to defaults', 'info');
        }

        async function refreshSignalHistory(timestamp) {
            const historyElement = document.getElementById(`history-${timestamp}`);
            if (!historyElement) return;
            
            // Show loading indicator
            historyElement.innerHTML = `
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="text-muted">Refreshing history...</small>
                </div>
            `;
            
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    console.error('No auth token found');
                    historyElement.innerHTML = '<div class="text-center py-2"><small class="text-danger">Authentication required</small></div>';
                    return;
                }

                const response = await fetch(`/api/signals/${timestamp}/history`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySignalHistory(timestamp, data.history);
                } else {
                    console.error('Failed to load signal history:', response.status);
                    historyElement.innerHTML = 
                        '<div class="text-center py-2"><small class="text-muted">No history available</small></div>';
                }
            } catch (error) {
                console.error('Error loading signal history:', error);
                historyElement.innerHTML = 
                    '<div class="text-center py-2"><small class="text-danger">Error loading history</small></div>';
            }
        }

        async function loadSignalHistory(timestamp) {
            // This function is kept for backward compatibility
            await refreshSignalHistory(timestamp);
        }

        function displaySignalHistory(timestamp, history) {
            const historyElement = document.getElementById(`history-${timestamp}`);
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<div class="text-center py-2"><small class="text-muted">No history events yet</small></div>';
                return;
            }

            const historyHTML = history.map(event => {
                const eventTime = new Date(event.timestamp).toLocaleString('en-US', {
                    timeZone: 'Asia/Jerusalem',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let eventIcon = 'üìù';
                let eventColor = 'secondary';
                
                switch (event.event_type) {
                    case 'signal_created':
                        eventIcon = 'üÜï';
                        eventColor = 'success';
                        break;
                    case 'status_changed':
                        eventIcon = 'üîÑ';
                        eventColor = 'warning';
                        break;
                    case 'threshold_updated':
                        eventIcon = '‚öôÔ∏è';
                        eventColor = 'info';
                        break;
                    case 'market_data_refreshed':
                        eventIcon = 'üìä';
                        eventColor = 'primary';
                        break;
                }

                return `
                    <div class="d-flex align-items-start mb-2 p-2 border-start border-3 border-${eventColor} bg-light">
                        <div class="me-2">
                            <span class="fs-5">${eventIcon}</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <strong class="text-${eventColor} small">${event.description}</strong>
                                <small class="text-muted">${eventTime}</small>
                            </div>
                            ${event.metadata && Object.keys(event.metadata).length > 0 ? `
                                <div class="mt-1">
                                    ${Object.entries(event.metadata).map(([key, value]) => {
                                        if (typeof value === 'object') return '';
                                        return `<small class="text-muted me-2"><strong>${key}:</strong> ${value}</small>`;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            historyElement.innerHTML = historyHTML;
            
            // Initialize tooltips for any info icons in the history
            const tooltipTriggerList = [].slice.call(historyElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        

        async function generateSignal() {
            const symbol = document.getElementById('symbol-input').value;
            const timeframe = document.getElementById('timeframe-input').value;
            
            if (!symbol) {
                alert('Please select a market from the dropdown');
                return;
            }
            
            // Show loading state
            const generateBtn = document.querySelector('button[onclick="generateSignal()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
            generateBtn.disabled = true;
            
            // Debug: Check form values immediately
            console.log('Form values at start of generateSignal:', {
                buyThreshold: document.getElementById('buy-threshold-input').value,
                sellThreshold: document.getElementById('sell-threshold-input').value,
                techWeight: document.getElementById('tech-weight-input').value,
                sentimentWeight: document.getElementById('sentiment-weight-input').value
            });
            
            // Get custom threshold values (empty strings become null for backend)
            const buyThresholdElement = document.getElementById('buy-threshold-input');
            const sellThresholdElement = document.getElementById('sell-threshold-input');
            const techWeightElement = document.getElementById('tech-weight-input');
            const sentimentWeightElement = document.getElementById('sentiment-weight-input');
            
            // Debug logging - check if elements exist
            console.log('Form elements found:', {
                buyThresholdElement: buyThresholdElement ? 'Found' : 'NOT FOUND',
                sellThresholdElement: sellThresholdElement ? 'Found' : 'NOT FOUND',
                techWeightElement: techWeightElement ? 'Found' : 'NOT FOUND',
                sentimentWeightElement: sentimentWeightElement ? 'Found' : 'NOT FOUND'
            });
            
            // Debug logging - check element details
            if (buyThresholdElement) {
                console.log('Buy threshold element details:', {
                    id: buyThresholdElement.id,
                    value: buyThresholdElement.value,
                    placeholder: buyThresholdElement.placeholder,
                    type: buyThresholdElement.type
                });
            }
            
            const buyThreshold = buyThresholdElement ? buyThresholdElement.value : '';
            const sellThreshold = sellThresholdElement ? sellThresholdElement.value : '';
            const techWeight = techWeightElement ? techWeightElement.value : '';
            const sentimentWeight = sentimentWeightElement ? sentimentWeightElement.value : '';
            
            // Debug logging
            console.log('Form values:', {
                buyThreshold,
                sellThreshold,
                techWeight,
                sentimentWeight
            });
            
            // Prepare request payload
            const payload = {
                symbol,
                timeframe,
                buy_threshold: buyThreshold === '' ? null : parseFloat(buyThreshold),
                sell_threshold: sellThreshold === '' ? null : parseFloat(sellThreshold),
                technical_weight: techWeight === '' ? null : parseFloat(techWeight),
                sentiment_weight: sentimentWeight === '' ? null : parseFloat(sentimentWeight)
            };
            
            // Debug logging
            console.log('Payload being sent:', payload);
            

            try {
                // Get authentication token
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Authentication required. Please login again.', 'error');
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch('/api/signals/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const signal = await response.json();
                    showSignalModal(signal);
                    await loadSignals(); // Refresh signals list
                    await updateStatus(); // Update status
                    
                    // Show success message
                    showNotification('Trading tip generated successfully!', 'success');
                } else {
                    const error = await response.json();
                    let errorMessage = error.detail || 'Unknown error occurred';
                    
                    // Provide helpful error messages for common issues
                    if (errorMessage.includes('Could not fetch market data')) {
                        errorMessage = `Unable to fetch market data for ${symbol}. This symbol may not be supported by your current data providers.`;
                    } else if (errorMessage.includes('API key') || errorMessage.includes('authentication')) {
                        errorMessage = `Authentication error. Please check your API keys for ${symbol}.`;
                    }
                    
                    showNotification(`Error: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('Error generating signal:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
            } finally {
                // Reset button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function showSignalModal(signal) {
            const modalBody = document.getElementById('signal-modal-body');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Trading Tip Details</h6>
                        <p><strong>Market:</strong> ${signal.symbol}</p>
                        <p><strong>Recommendation:</strong> <span class="badge bg-${getSignalColor(signal.signal_type)}">${signal.signal_type}</span></p>
                        <p><strong>Confidence:</strong> ${(signal.confidence * 100).toFixed(1)}%</p>
                        <p><strong>Generated:</strong> ${new Date(signal.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Scores</h6>
                        <p><strong>Technical:</strong> ${signal.technical_score.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Combines RSI and MACD indicators. Range: -1 to +1. Positive = bullish momentum, Negative = bearish momentum. Calculated as: (RSI_score + MACD_score) / 2"></i>
                        </p>
                        <p><strong>Sentiment:</strong> ${signal.sentiment_score.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="News sentiment analysis using FinBERT model. Range: -1 to +1. Positive = bullish news, Negative = bearish news. Based on recent market headlines from Google News RSS feeds."></i>
                        </p>
                        <p><strong>Fused:</strong> ${signal.fused_score.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Final signal score combining technical and sentiment analysis. Formula: (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score). Range: -1 to +1. Used to determine BUY/SELL/HOLD signals."></i>
                        </p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Risk Management</h6>
                        ${signal.stop_loss ? `<p><strong>Stop Loss:</strong> ${signal.stop_loss.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Automatic exit price to limit losses. Calculated as: Current Price ¬± (2 √ó ATR). For BUY signals: Current Price - (2 √ó ATR). For SELL signals: Current Price + (2 √ó ATR). ATR = Average True Range (volatility measure)."></i>
                        </p>` : ''}
                        ${signal.take_profit ? `<p><strong>Take Profit:</strong> ${signal.take_profit.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Target profit exit price. Calculated as: Current Price ¬± (3 √ó ATR). For BUY signals: Current Price + (3 √ó ATR). For SELL signals: Current Price - (3 √ó ATR). Risk-reward ratio is 1:1.5 (2 ATR risk vs 3 ATR reward)."></i>
                        </p>` : ''}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Applied Thresholds</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Buy Threshold:</strong> ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : 'Default (0.5)'}</p>
                                <p><strong>Sell Threshold:</strong> ${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : 'Default (-0.5)'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Tech Weight:</strong> ${signal.applied_tech_weight !== null ? signal.applied_tech_weight.toFixed(2) : 'Default (0.6)'}</p>
                                <p><strong>Sentiment Weight:</strong> ${signal.applied_sentiment_weight !== null ? signal.applied_sentiment_weight.toFixed(2) : 'Default (0.4)'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Reasoning</h6>
                        <p>${signal.reasoning}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('signalModal'));
            modal.show();
        }



        function runBacktest() {
            alert('Backtest functionality will be implemented in the CLI integration');
        }

        function runTune() {
            alert('Auto-tune functionality will be implemented in the CLI integration');
        }

        function runSchedule() {
            alert('Scheduler functionality will be implemented in the CLI integration');
        }


        // Loading state management
        function showLoadingStates() {
            // Show loading for total signals
            document.getElementById('total-signals').innerHTML = '<i class="bi bi-hourglass-split"></i>';
            document.getElementById('total-signals').className = 'text-muted';
            
            // Show loading for active symbols
            document.getElementById('active-symbols').innerHTML = '<i class="bi bi-hourglass-split"></i>';
            document.getElementById('active-symbols').className = 'text-muted';
            
            // Show loading for market dropdown
            const symbolSelect = document.getElementById('symbol-input');
            symbolSelect.innerHTML = '<option value="">Loading markets...</option>';
            symbolSelect.disabled = true;
            
            // Show loading for trading tips container
            const signalsContainer = document.getElementById('signals-container');
            signalsContainer.innerHTML = '<div class="text-center py-4"><i class="bi bi-hourglass-split fs-1 text-muted"></i><p class="text-muted mt-2">Loading trading tips...</p></div>';
        }

        function hideLoadingStates() {
            // Re-enable symbol dropdown
            const symbolSelect = document.getElementById('symbol-input');
            symbolSelect.disabled = false;
            
            // Clear loading state for signals container if it's still showing loading
            const signalsContainer = document.getElementById('signals-container');
            if (signalsContainer && signalsContainer.innerHTML.includes('Loading trading tips')) {
                signalsContainer.innerHTML = '<p class="text-muted">No trading tips generated yet.</p>';
            }
        }

        // Market Data Functions
        
        let marketDataInterval = null;
        
        async function loadMarketData() {
            await Promise.all([
                loadPriceSummaryCards(),
                loadPerformanceRanking(),
                loadMarketStatistics()
            ]);
        }
        
        async function loadPriceSummaryCards() {
            try {
                // Use the new overview endpoint for real-time data with default timeframe
                const response = await fetch('/api/market-data/all/overview?timeframe=15m');
                if (!response.ok) {
                    throw new Error('Failed to fetch market overview');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('price-summary-cards');
                let cardsHTML = '';
                
                marketData.symbols.forEach(symbolData => {
                    if (symbolData.error) {
                        // Error card
                        cardsHTML += `
                            <div class="col-md-4 mb-2">
                                <div class="card h-100 border-warning">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1">${symbolData.symbol}</h6>
                                        <p class="text-warning mb-0">${symbolData.error}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const isPositive = symbolData.change >= 0;
                        const priceColor = isPositive ? 'success' : 'danger';
                        
                        cardsHTML += `
                            <div class="col-md-4 mb-2">
                                <div class="card h-100 ${isPositive ? 'border-success' : 'border-danger'} shadow-sm">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${symbolData.symbol}</h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="h5 mb-0">$${symbolData.price.toFixed(2)}</span>
                                                    <span class="ms-2 badge bg-${priceColor}">
                                                        ${isPositive ? '+' : ''}${symbolData.change_percent.toFixed(2)}%
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    Change: ${isPositive ? '+' : ''}$${symbolData.change.toFixed(2)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <i class="bi bi-arrow-${isPositive ? 'up' : 'down'}-right text-${priceColor} fs-4"></i>
                                                <div class="mt-1">
                                                    <small class="text-muted">Vol: ${symbolData.volume.toLocaleString()}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.innerHTML = cardsHTML;
                
                // Update last refresh time
                const lastUpdate = new Date(marketData.timestamp).toLocaleTimeString();
                document.getElementById('last-market-update').textContent = lastUpdate;
                
            } catch (error) {
                console.error('Error loading price summary cards:', error);
                const container = document.getElementById('price-summary-cards');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Error loading market data: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        
        async function loadPerformanceRanking() {
            try {
                // Use the overview endpoint for real performance data
                const response = await fetch('/api/market-data/all/overview');
                if (!response.ok) {
                    throw new Error('Failed to fetch performance data');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('performance-ranking');
                let rankingHTML = '';
                
                // Sort by performance
                const performances = marketData.symbols
                    .filter(s => !s.error)
                    .sort((a, b) => b.change_percent - a.change_percent);
                
                performances.forEach((perf, index) => {
                    const isPositive = perf.change_percent >= 0;
                    const rankClass = index === 0 ? 'text-warning' : index === 1 ? 'text-secondary' : index === 2 ? 'text-bronze' : '';
                    
                    rankingHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${index + 1}</span>
                                <span class="${rankClass}">${perf.symbol}</span>
                            </div>
                            <span class="badge bg-${isPositive ? 'success' : 'danger'}">
                                ${isPositive ? '+' : ''}${perf.change_percent.toFixed(2)}%
                            </span>
                        </div>
                    `;
                });
                
                container.innerHTML = rankingHTML || '<p class="text-muted">No performance data available</p>';
            } catch (error) {
                console.error('Error loading performance ranking:', error);
                const container = document.getElementById('performance-ranking');
                container.innerHTML = '<p class="text-warning">Error loading performance data</p>';
            }
        }
        
        async function loadMarketStatistics() {
            try {
                // Use the overview endpoint for real statistics
                const response = await fetch('/api/market-data/all/overview');
                if (!response.ok) {
                    throw new Error('Failed to fetch market statistics');
                }
                
                const marketData = await response.json();
                const container = document.getElementById('market-statistics');
                let statsHTML = '';
                
                // Calculate statistics from real data
                const validSymbols = marketData.symbols.filter(s => !s.error);
                const totalVolume = validSymbols.reduce((sum, s) => sum + s.volume, 0);
                const totalChange = validSymbols.reduce((sum, s) => sum + s.change_percent, 0);
                const symbolCount = validSymbols.length;
                
                const avgChange = symbolCount > 0 ? totalChange / symbolCount : 0;
                const marketSentiment = avgChange > 1 ? 'Bullish' : avgChange < -1 ? 'Bearish' : 'Neutral';
                const sentimentColor = avgChange > 1 ? 'success' : avgChange < -1 ? 'danger' : 'warning';
                
                // Calculate additional metrics
                const upSymbols = validSymbols.filter(s => s.change_percent > 0).length;
                const downSymbols = validSymbols.filter(s => s.change_percent < 0).length;
                const flatSymbols = validSymbols.filter(s => s.change_percent === 0).length;
                
                statsHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Market Sentiment</h6>
                                <span class="badge bg-${sentimentColor} fs-6">${marketSentiment}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Avg Change</h6>
                                <span class="badge bg-${avgChange >= 0 ? 'success' : 'danger'} fs-6">
                                    ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <div class="text-center mb-2">
                                <h6 class="text-muted">Symbol Performance</h6>
                                <div class="d-flex justify-content-around">
                                    <span class="badge bg-success">${upSymbols} Up</span>
                                    <span class="badge bg-danger">${downSymbols} Down</span>
                                    <span class="badge bg-secondary">${flatSymbols} Flat</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Active Symbols:</strong> ${symbolCount}<br>
                                <strong>Total Volume:</strong> ${totalVolume.toLocaleString()}<br>
                                <strong>Data Source:</strong> Live Market Data<br>
                                <strong>Last Update:</strong> ${new Date(marketData.timestamp).toLocaleTimeString()}
                            </small>
                        </div>
                    </div>
                `;
                
                container.innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading market statistics:', error);
                const container = document.getElementById('market-statistics');
                container.innerHTML = '<p class="text-warning">Error loading market statistics</p>';
            }
        }
        

        
        // Start market data updates
        function startMarketDataUpdates() {
            marketDataInterval = setInterval(loadMarketData, 30000); // Update every 30 seconds
        }
        
        
        // User Profile Functions
        async function showUserProfile() {
            try {
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    
                    // Populate the form
                    document.getElementById('profile-username').value = profile.username || '';
                    document.getElementById('profile-role').value = profile.role || '';
                    document.getElementById('profile-first-name').value = profile.first_name || '';
                    document.getElementById('profile-last-name').value = profile.last_name || '';
                    document.getElementById('profile-email').value = profile.email || '';
                    document.getElementById('profile-phone').value = profile.phone || '';
                    document.getElementById('profile-additional-info').value = profile.additional_info || '';
                    document.getElementById('profile-created-at').value = profile.created_at ? new Date(profile.created_at).toLocaleString() : '';
                    document.getElementById('profile-last-login').value = profile.last_login ? new Date(profile.last_login).toLocaleString() : '';
                    document.getElementById('profile-status').value = profile.status || '';
                    
                    // Format activation period
                    let activationText = 'N/A';
                    if (profile.activation_days !== null && profile.activation_days !== undefined) {
                        if (profile.activation_days === 0) {
                            activationText = 'Deactivated';
                        } else if (profile.activation_expires_at) {
                            const expiryDate = new Date(profile.activation_expires_at);
                            const now = new Date();
                            const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                            if (daysLeft > 0) {
                                activationText = `${daysLeft} days left (expires ${expiryDate.toLocaleDateString()})`;
                            } else {
                                activationText = 'Expired';
                            }
                        } else {
                            activationText = 'Permanent';
                        }
                    }
                    document.getElementById('profile-activation').value = activationText;
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
                    modal.show();
                } else {
                    const error = await response.json();
                    alert('Error loading profile: ' + error.detail);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile');
            }
        }
        
        async function updateUserProfile() {
            try {
                const profileData = {
                    first_name: document.getElementById('profile-first-name').value.trim() || null,
                    last_name: document.getElementById('profile-last-name').value.trim() || null,
                    email: document.getElementById('profile-email').value.trim() || null,
                    phone: document.getElementById('profile-phone').value.trim() || null,
                    additional_info: document.getElementById('profile-additional-info').value.trim() || null
                };
                
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Profile updated successfully!');
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userProfileModal'));
                    modal.hide();
                } else {
                    const error = await response.json();
                    alert('Error updating profile: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        }
        
        function showChangePassword() {
            // Clear the form
            document.getElementById('changePasswordForm').reset();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }
        
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('Please fill in all password fields');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long');
                    return;
                }
                
                const passwordData = {
                    current_password: currentPassword,
                    new_password: newPassword
                };
                
                const response = await fetch('/api/user/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(passwordData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Password changed successfully!');
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                } else {
                    const error = await response.json();
                    alert('Error changing password: ' + error.detail);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });
    </script>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userProfileModalLabel">
                        <i class="bi bi-person-circle me-2"></i>User Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userProfileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="profile-username" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-role" class="form-label">Role</label>
                                    <input type="text" class="form-control" id="profile-role" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-first-name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="profile-first-name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-last-name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="profile-last-name">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profile-email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="profile-phone">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="profile-additional-info" class="form-label">Additional Information</label>
                            <textarea class="form-control" id="profile-additional-info" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-created-at" class="form-label">Created At</label>
                                    <input type="text" class="form-control" id="profile-created-at" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-last-login" class="form-label">Last Login</label>
                                    <input type="text" class="form-control" id="profile-last-login" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-status" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="profile-status" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-activation" class="form-label">Activation Period</label>
                                    <input type="text" class="form-control" id="profile-activation" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateUserProfile()">
                        <i class="bi bi-check-lg me-1"></i>Update Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="bi bi-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new-password" required minlength="6">
                            <div class="form-text">Password must be at least 6 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm-password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">
                        <i class="bi bi-check-lg me-1"></i>Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
