<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-buy { color: #28a745; }
        .signal-sell { color: #dc3545; }
        .signal-hold { color: #6c757d; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .chart-container { position: relative; height: 300px; }
        .signal-card { border-left: 4px solid #dee2e6; }
        .signal-card.buy { border-left-color: #28a745; }
        .signal-card.sell { border-left-color: #dc3545; }
        .signal-card.hold { border-left-color: #6c757d; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow me-2"></i> Trading AI Tips
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <span id="status-indicator" class="status-indicator status-running"></span>
                    <span id="status-text">Running</span>
                </span>
                
                <!-- Message Notification -->
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light position-relative" type="button" id="messageDropdown" data-bs-toggle="dropdown" aria-expanded="false" onclick="loadUserMessages()">
                        <i class="bi bi-envelope"></i>
                        <span id="message-count-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                            0
                        </span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="messageDropdown" style="min-width: 300px;">
                        <li><h6 class="dropdown-header">Messages from Admin</h6></li>
                        <li><div id="user-messages-list" class="px-3 py-2">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Loading messages...
                            </div>
                        </div></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center" href="#" onclick="showMessagesModal()">
                            <i class="bi bi-chat-dots me-2"></i>View All Messages
                        </a></li>
                    </ul>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-1"></i>
                        <span id="user-username">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><h6 class="dropdown-header">User Profile</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="showUserProfile()">
                            <i class="bi bi-person me-2"></i>View Profile
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="showChangePassword()">
                            <i class="bi bi-key me-2"></i>Change Password
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Maintenance Notification -->
        <div id="maintenance-notification" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-tools me-2 fs-5"></i>
                <div class="flex-grow-1">
                    <strong>System Maintenance Notice:</strong>
                    <span id="maintenance-message"></span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
        
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Trading Tips</h5>
                        <h3 id="total-signals" class="text-primary">0</h3>
                        <small class="text-muted">Total Generated</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Markets</h5>
                        <h3 id="active-symbols" class="text-info">0</h3>
                        <small class="text-muted">Active Trading</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Main Column -->
            <div class="col-12">
                <!-- Trading Tip Generation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Generate Trading Tip</h5>
                    </div>
                    <div class="card-body">
                        <!-- Custom Thresholds Section -->
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-2"></i>
                                <div>
                                    <strong>Custom Thresholds:</strong> Set your own signal generation parameters or leave empty to use system defaults.
                                    <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#thresholds-help">
                                        <i class="bi bi-question-circle"></i> Learn More
                                    </button>
                                </div>
                            </div>
                            <div class="collapse mt-2" id="thresholds-help">
                                <div class="card card-body bg-light">
                                    <h6 class="text-primary mb-3">üéì Trading Terms Explained</h6>
                                    
                                    <!-- Technical Indicators -->
                                    <div class="mb-4">
                                        <h6 class="text-success">üìà Technical Indicators</h6>
                                        
                                        <div class="mb-3">
                                            <strong>RSI (Relative Strength Index)</strong>
                                            <p class="mb-1"><small class="text-muted">Measures if a market is overbought or oversold</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>Range:</strong> 0 to 100</li>
                                                <li><strong>Overbought:</strong> RSI > 70 (market might fall)</li>
                                                <li><strong>Oversold:</strong> RSI < 30 (market might rise)</li>
                                                <li><strong>Our Score:</strong> (RSI - 50) √∑ 50 ‚Üí Range: -1 to +1</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>MACD (Moving Average Convergence Divergence)</strong>
                                            <p class="mb-1"><small class="text-muted">Shows trend changes and momentum</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>What it shows:</strong> When short-term trend crosses long-term trend</li>
                                                <li><strong>Positive:</strong> Upward momentum (bullish)</li>
                                                <li><strong>Negative:</strong> Downward momentum (bearish)</li>
                                                <li><strong>Our Score:</strong> MACD Histogram √∑ 1000 ‚Üí Range: -1 to +1</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>ATR (Average True Range)</strong>
                                            <p class="mb-1"><small class="text-muted">Measures market volatility for stop-loss and take-profit</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>High ATR:</strong> Market is volatile (wider stops needed)</li>
                                                <li><strong>Low ATR:</strong> Market is calm (tighter stops possible)</li>
                                                <li><strong>Used for:</strong> Stop Loss = <span id="atr-stop-multiplier">2</span>√óATR, Take Profit = <span id="atr-tp-multiplier">3</span>√óATR</li>
                                            </ul>
                                        </div>
                                            </div>
                                            
                                    <!-- Sentiment Analysis -->
                                    <div class="mb-4">
                                        <h6 class="text-info">üì∞ Sentiment Analysis</h6>
                                        <div class="mb-3">
                                            <strong><span id="sentiment-model-name">FinBERT Model</span></strong>
                                            <p class="mb-1"><small class="text-muted">AI that reads news headlines and determines market sentiment</small></p>
                                            <ul class="small mb-2">
                                                <li><strong>Positive News:</strong> +1 (bullish sentiment)</li>
                                                <li><strong>Negative News:</strong> -1 (bearish sentiment)</li>
                                                <li><strong>Neutral News:</strong> 0 (no clear direction)</li>
                                                <li><strong>Sources:</strong> <span id="sentiment-sources">Google News RSS feeds</span> for stocks and crypto</li>
                                            </ul>
                                            </div>
                                        </div>
                                    
                                    <!-- Signal Generation -->
                                    <div class="mb-4">
                                        <h6 class="text-warning">üéØ How Signals Are Generated</h6>
                                        <div class="bg-white p-3 rounded border">
                                            <strong>Step 1: Calculate Technical Score</strong><br>
                                            <code class="small">Technical Score = (RSI Score + MACD Score) √∑ 2</code><br><br>
                                            
                                            <strong>Step 2: Get Sentiment Score</strong><br>
                                            <code class="small">Sentiment Score = FinBERT analysis of news headlines</code><br><br>
                                            
                                            <strong>Step 3: Combine with Weights</strong><br>
                                            <code class="small">Final Score = (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score)</code><br><br>
                                            
                                            <strong>Step 4: Generate Signal</strong><br>
                                            <ul class="small mb-0">
                                                <li><strong>BUY:</strong> Final Score ‚â• Buy Threshold (e.g., 0.5)</li>
                                                <li><strong>SELL:</strong> Final Score ‚â§ Sell Threshold (e.g., -0.5)</li>
                                                <li><strong>HOLD:</strong> Final Score between thresholds</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Example -->
                                    <div class="mb-3">
                                        <h6 class="text-secondary">üí° Real Example</h6>
                                        <div class="bg-light p-3 rounded">
                                            <strong>Market:</strong> BTC/USDT<br>
                                            <strong>RSI:</strong> 45 ‚Üí Score: (45-50)√∑50 = -0.1<br>
                                            <strong>MACD:</strong> -0.5 ‚Üí Score: -0.5√∑1000 = -0.0005<br>
                                            <strong>Technical Score:</strong> (-0.1 + -0.0005) √∑ 2 = -0.05<br>
                                            <strong>Sentiment:</strong> -0.2 (negative news)<br>
                                            <strong>Weights:</strong> Tech 60%, Sentiment 40%<br>
                                            <strong>Final Score:</strong> (0.6 √ó -0.05) + (0.4 √ó -0.2) = -0.11<br>
                                            <strong>Result:</strong> HOLD (between -0.5 and +0.5)
                                        </div>
                                    </div>
                                    
                                    <!-- Thresholds -->
                                    <div class="mb-3">
                                        <h6 class="text-primary">‚öôÔ∏è Threshold Settings</h6>
                                        <ul class="small mb-2">
                                            <li><strong>Buy Threshold:</strong> How strong the signal must be to recommend buying</li>
                                            <li><strong>Sell Threshold:</strong> How negative the signal must be to recommend selling</li>
                                            <li><strong>Higher thresholds:</strong> Fewer but more reliable signals</li>
                                            <li><strong>Lower thresholds:</strong> More signals but less reliable</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="buy-threshold-input" class="form-label">
                                        Buy Threshold 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Minimum fused score for BUY signals. Range: 0.1-1.0. Higher = more conservative. Default: 0.2"></i>
                                    </label>
                                    <input type="number" class="form-control" id="buy-threshold-input" 
                                           placeholder="0.2" step="0.1" min="-1" max="1" 
                                           title="Buy signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sell-threshold-input" class="form-label">
                                        Sell Threshold 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Maximum fused score for SELL signals. Range: -1.0 to -0.1. More negative = more conservative. Default: -0.2"></i>
                                    </label>
                                    <input type="number" class="form-control" id="sell-threshold-input" 
                                           placeholder="-0.2" step="0.1" min="-1" max="1" 
                                           title="Sell signal threshold (-1 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tech-weight-input" class="form-label">
                                        Technical Weight 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="How much technical indicators (RSI, MACD) influence the signal. Range: 0.0-1.0. Must add up to 1.0 with sentiment weight. Default: 0.5"></i>
                                    </label>
                                    <input type="number" class="form-control" id="tech-weight-input" 
                                           placeholder="0.5" step="0.1" min="0" max="1" 
                                           title="Weight for technical analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sentiment-weight-input" class="form-label">
                                        Sentiment Weight 
                                        <i class="bi bi-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="How much news sentiment analysis influences the signal. Range: 0.0-1.0. Must add up to 1.0 with technical weight. Default: 0.5"></i>
                                    </label>
                                    <input type="number" class="form-control" id="sentiment-weight-input" 
                                           placeholder="0.5" step="0.1" min="0" max="1" 
                                           title="Weight for sentiment analysis (0 to 1, leave empty for default)">
                                    <small class="form-text text-muted">Leave empty to use default</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> Technical Weight + Sentiment Weight must equal 1.0
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="symbol-input" class="form-label">Market</label>
                                    <select class="form-select" id="symbol-input">
                                        <option value="">Loading markets...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timeframe-input" class="form-label">Timeframe</label>
                                    <select class="form-select" id="timeframe-input">
                                        <option value="">Loading timeframes...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="generateSignal()">
                                <i class="bi bi-play-circle"></i> Generate Trading Tip
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetThresholds()">
                                <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                            </button>
                        </div>

                    </div>
                </div>

                <!-- Recent Trading Tips -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Recent Trading Tips</h5>
                    </div>
                    <div class="card-body">
                        <div id="signals-container">
                            <!-- Signals will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Market Overview -->
                <div class="row mb-4">
                    <!-- Cryptocurrency Market -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-currency-bitcoin"></i> Cryptocurrency</h5>
                                <small class="text-light">Last updated: <span id="last-crypto-update">-</span></small>
                    </div>
                    <div class="card-body">
                                <div class="row" id="crypto-price-cards">
                                    <!-- Crypto price cards will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock Market -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Stock Market</h5>
                                <small class="text-light">Last updated: <span id="last-stock-update">-</span></small>
                            </div>
                            <div class="card-body">
                                <div class="row" id="stock-price-cards">
                                    <!-- Stock price cards will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Ranking and Market Statistics -->
                <div class="row mb-4">
                    <!-- Performance Ranking -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-trophy"></i> Performance Ranking</h5>
                            </div>
                            <div class="card-body">
                                <div id="performance-ranking">
                                    <!-- Performance ranking will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Statistics -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Market Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div id="market-statistics">
                                    <!-- Market statistics will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Signal Modal -->
    <div class="modal fade" id="signalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Trading Tip Generated</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="signal-modal-body">
                    <!-- Signal details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Notification System -->
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
    
    <script>
        // Global variables
        let statusUpdateInterval = null;
        let messageRefreshInterval = null;
        let isLoggingOut = false;
        let isLoadingMessages = false;

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-info';
            
            notification.className = `alert ${bgClass} text-white border-0 shadow-sm mb-2`;
            notification.style.minWidth = '300px';
            // Convert line breaks to HTML <br> tags for proper formatting
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            notification.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 
                                     type === 'error' ? 'x-circle' : 
                                     type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <span>${formattedMessage}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after duration only for non-error messages
            // Error messages should stay until user manually closes them
            if (type !== 'error') {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('auth_token');
            const role = localStorage.getItem('user_role');
            
            if (!token || !role) {
                // Not authenticated, redirect to login
                window.location.href = '/login';
                return;
            }
            
            // User is authenticated, initialize dashboard
            checkAuth();
            initializeDashboard();
            startStatusUpdates();
            startMessageRefresh();
            
            // Load user messages for notification dropdown
            loadUserMessages();
            
            // Initialize tooltips for form elements
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Cleanup intervals when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
            if (aiAnalysisInterval) {
                clearInterval(aiAnalysisInterval);
            }
        });

        // AI Analysis Modal Functions
        let aiAnalysisInterval = null;
        let currentAnalysisStep = 0;
        
        function showAIAnalysisModal(symbol, timeframe) {
            return new Promise((resolve) => {
            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <h5 class="modal-title" id="aiAnalysisModalLabel">
                                    <i class="bi bi-cpu me-2"></i>AI Trading Analysis
                                </h5>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="ai-brain-animation mb-3">
                                        <div class="brain-container">
                                            <div class="brain-pulse"></div>
                                            <div class="brain-core">
                                                <i class="bi bi-cpu-fill"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <h4 class="text-primary mb-2">Analyzing ${symbol}</h4>
                                    <p class="text-muted">AI is processing market data and generating insights...</p>
                                </div>
                                
                                <div class="analysis-steps">
                                    <div class="step" id="step-1">
                                        <div class="step-icon"><i class="bi bi-download"></i></div>
                                        <div class="step-content">
                                            <h6>Fetching Market Data</h6>
                                            <p>Retrieving OHLCV data and price history</p>
                                        </div>
                                        <div class="step-status"><i class="bi bi-hourglass-split"></i></div>
                                    </div>
                                    
                                    <div class="step" id="step-2">
                                        <div class="step-icon"><i class="bi bi-graph-up"></i></div>
                                        <div class="step-content">
                                            <h6>Technical Analysis</h6>
                                            <p>Calculating RSI, MACD, ATR, and EMA indicators</p>
                                        </div>
                                        <div class="step-status"><i class="bi bi-hourglass-split"></i></div>
                                    </div>
                                    
                                    <div class="step" id="step-3">
                                        <div class="step-icon"><i class="bi bi-newspaper"></i></div>
                                        <div class="step-content">
                                            <h6>Sentiment Analysis</h6>
                                            <p>Processing news headlines and social media sentiment</p>
                                        </div>
                                        <div class="step-status"><i class="bi bi-hourglass-split"></i></div>
                                    </div>
                                    
                                    <div class="step" id="step-4">
                                        <div class="step-icon"><i class="bi bi-lightning"></i></div>
                                        <div class="step-content">
                                            <h6>AI Fusion Engine</h6>
                                            <p>Combining technical and sentiment data with machine learning</p>
                                        </div>
                                        <div class="step-status"><i class="bi bi-hourglass-split"></i></div>
                                    </div>
                                    
                                    <div class="step" id="step-5">
                                        <div class="step-icon"><i class="bi bi-check-circle"></i></div>
                                        <div class="step-content">
                                            <h6>Generating Signal</h6>
                                            <p>Creating final trading recommendation</p>
                                        </div>
                                        <div class="step-status"><i class="bi bi-hourglass-split"></i></div>
                                    </div>
                                </div>
                                
                                <div class="progress-container mt-4">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" role="progressbar" style="width: 0%" id="ai-progress-bar"></div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <small class="text-muted" id="progress-text">Initializing AI analysis...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('aiAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add CSS for animations
            addAIAnalysisCSS();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
            modal.show();
            
            // Start analysis animation
            startAIAnalysis(resolve);
            });
        }
        
        function addAIAnalysisCSS() {
            const css = `
                <style>
                .ai-brain-animation {
                    position: relative;
                    display: inline-block;
                }
                
                .brain-container {
                    position: relative;
                    width: 80px;
                    height: 80px;
                }
                
                .brain-core {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 40px;
                    height: 40px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 20px;
                    z-index: 2;
                    animation: brainPulse 2s ease-in-out infinite;
                }
                
                .brain-pulse {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 80px;
                    height: 80px;
                    border: 3px solid #667eea;
                    border-radius: 50%;
                    animation: pulse 2s ease-in-out infinite;
                }
                
                @keyframes brainPulse {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                }
                
                @keyframes pulse {
                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
                }
                
                .analysis-steps {
                    max-width: 500px;
                    margin: 0 auto;
                }
                
                .step {
                    display: flex;
                    align-items: center;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 10px;
                    background: #f8f9fa;
                    border-left: 4px solid #e9ecef;
                    transition: all 0.3s ease;
                }
                
                .step.active {
                    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                    border-left-color: #667eea;
                    transform: translateX(5px);
                }
                
                .step.completed {
                    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
                    border-left-color: #28a745;
                    border-left-width: 5px;
                }
                
                .step-icon {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: #e9ecef;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                    font-size: 18px;
                    color: #6c757d;
                    transition: all 0.3s ease;
                }
                
                .step.active .step-icon {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    animation: iconPulse 1.5s ease-in-out infinite;
                }
                
                .step.completed .step-icon {
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    animation: completedPulse 0.5s ease-in-out;
                }
                
                @keyframes completedPulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); }
                }
                
                @keyframes iconPulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
                
                .step-content {
                    flex: 1;
                }
                
                .step-content h6 {
                    margin: 0 0 5px 0;
                    font-weight: 600;
                    color: #333;
                }
                
                .step-content p {
                    margin: 0;
                    font-size: 14px;
                    color: #666;
                }
                
                .step-status {
                    font-size: 20px;
                    color: #6c757d;
                    transition: all 0.3s ease;
                }
                
                .step.active .step-status {
                    color: #667eea;
                    animation: spin 1s linear infinite;
                }
                
                .step.completed .step-status {
                    color: #28a745;
                    animation: checkmarkPulse 0.5s ease-in-out;
                }
                
                @keyframes checkmarkPulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.2); }
                    100% { transform: scale(1); }
                }
                
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                
                .bg-gradient {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                }
                </style>
            `;
            
            // Remove existing CSS if any
            const existingCSS = document.getElementById('ai-analysis-css');
            if (existingCSS) {
                existingCSS.remove();
            }
            
            // Add CSS to head
            const style = document.createElement('div');
            style.id = 'ai-analysis-css';
            style.innerHTML = css;
            document.head.appendChild(style);
        }
        
        function startAIAnalysis(resolve) {
            currentAnalysisStep = 0;
            const steps = [
                { id: 'step-1', text: 'Fetching market data...', duration: 3000 },
                { id: 'step-2', text: 'Calculating technical indicators...', duration: 3000 },
                { id: 'step-3', text: 'Analyzing market sentiment...', duration: 3000 },
                { id: 'step-4', text: 'Running AI fusion algorithm...', duration: 3000 },
                { id: 'step-5', text: 'Generating final signal...', duration: 3000 }
            ];
            
            let totalDuration = 0;
            steps.forEach(step => totalDuration += step.duration);
            
            let currentTime = 0;
            let stepStartTime = 0;
            
            // Activate first step immediately
            if (steps.length > 0) {
                const firstStep = steps[0];
                const firstStepElement = document.getElementById(firstStep.id);
                if (firstStepElement) {
                    firstStepElement.classList.add('active');
                    const firstStatus = firstStepElement.querySelector('.step-status');
                    if (firstStatus) {
                        firstStatus.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    }
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        progressText.textContent = firstStep.text;
                    }
                }
            }
            
            // Update progress bar smoothly every 100ms
            const progressInterval = setInterval(() => {
                currentTime += 100;
                const progress = Math.min((currentTime / totalDuration) * 100, 100);
                const progressBar = document.getElementById('ai-progress-bar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                // Check if we need to move to next step
                if (currentAnalysisStep < steps.length) {
                    const step = steps[currentAnalysisStep];
                    const stepEndTime = stepStartTime + step.duration;
                    
                    if (currentTime >= stepEndTime) {
                        // Complete current step
                        const stepElement = document.getElementById(step.id);
                        if (stepElement) {
                            stepElement.classList.remove('active');
                            stepElement.classList.add('completed');
                            const status = stepElement.querySelector('.step-status');
                            if (status) {
                                status.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                            }
                        }
                        
                        // Move to next step
                        currentAnalysisStep++;
                        stepStartTime = currentTime;
                        
                        if (currentAnalysisStep < steps.length) {
                            const nextStep = steps[currentAnalysisStep];
                            const nextStepElement = document.getElementById(nextStep.id);
                            if (nextStepElement) {
                                nextStepElement.classList.add('active');
                                const nextStatus = nextStepElement.querySelector('.step-status');
                                if (nextStatus) {
                                    nextStatus.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                                }
                                
                                // Update progress text
                                const progressText = document.getElementById('progress-text');
                                if (progressText) {
                                    progressText.textContent = nextStep.text;
                                }
                            }
                        }
                    }
                }
                
                // Check if analysis is complete
                if (currentTime >= totalDuration) {
                    // Analysis complete - but don't hide modal yet
                    clearInterval(progressInterval);
                    // Mark all steps as completed
                    for (let i = 0; i < steps.length; i++) {
                        const stepElement = document.getElementById(steps[i].id);
                        if (stepElement) {
                            stepElement.classList.remove('active');
                            stepElement.classList.add('completed');
                            const status = stepElement.querySelector('.step-status');
                            if (status) {
                                status.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                            }
                        }
                    }
                    // Update progress to 100%
                    const progressBar = document.getElementById('ai-progress-bar');
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                    // Update final status text
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        progressText.textContent = 'AI analysis complete! Generating signal...';
                    }
                    if (resolve) resolve(); // Resolve the promise but keep modal open
                }
            }, 100);
        }
        
        function hideAIAnalysisModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiAnalysisModal'));
            if (modal) {
                modal.hide();
            }
            
            // Clean up
            setTimeout(() => {
                const modalElement = document.getElementById('aiAnalysisModal');
                if (modalElement) {
                    modalElement.remove();
                }
                const cssElement = document.getElementById('ai-analysis-css');
                if (cssElement) {
                    cssElement.remove();
                }
            }, 300);
        }
        
        function showSignalCompletionModal(signal) {
            // Create completion modal HTML
            const modalHTML = `
                <div class="modal fade" id="signalCompletionModal" tabindex="-1" aria-labelledby="signalCompletionModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="signalCompletionModalLabel">
                                    <i class="bi bi-check-circle-fill me-2"></i>AI Analysis Complete!
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="success-animation mb-3">
                                        <div class="success-icon">
                                            <i class="bi bi-lightning-fill"></i>
                                        </div>
                                    </div>
                                    <h4 class="text-success mb-2">Trading Signal Generated!</h4>
                                    <p class="text-muted">AI has successfully analyzed ${signal.symbol} and generated a trading recommendation.</p>
                                </div>
                                
                                <div class="signal-summary">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-primary">Signal Type</h6>
                                                    <h3 class="mb-0 ${signal.signal_type === 'BUY' ? 'text-success' : signal.signal_type === 'SELL' ? 'text-danger' : 'text-warning'}">
                                                        ${signal.signal_type}
                                                    </h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-primary">Confidence</h6>
                                                    <h3 class="mb-0 text-info">${(signal.confidence * 100).toFixed(1)}%</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-primary">Technical Score</h6>
                                                    <h4 class="mb-0 text-secondary">${signal.technical_score.toFixed(3)}</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-primary">Sentiment Score</h6>
                                                    <h4 class="mb-0 text-secondary">${(signal.sentiment_score || 0).toFixed(3)}</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal" onclick="refreshSignalsAfterCompletion()">
                                        <i class="bi bi-check-circle me-2"></i>OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('signalCompletionModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add CSS for success animation
            addCompletionModalCSS();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('signalCompletionModal'));
            modal.show();
        }
        
        function refreshSignalsAfterCompletion() {
            // Refresh signals list when user clicks OK on completion modal
            loadSignals();
            updateStatus();
        }
        
        function addCompletionModalCSS() {
            const css = `
                <style>
                .success-animation {
                    position: relative;
                    display: inline-block;
                }
                
                .success-icon {
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 40px;
                    animation: successPulse 2s ease-in-out infinite;
                }
                
                @keyframes successPulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
                
                .signal-summary .card {
                    transition: transform 0.2s ease;
                }
                
                .signal-summary .card:hover {
                    transform: translateY(-2px);
                }
                </style>
            `;
            
            // Remove existing CSS if any
            const existingCSS = document.getElementById('completion-modal-css');
            if (existingCSS) {
                existingCSS.remove();
            }
            
            // Add CSS to head
            const style = document.createElement('div');
            style.id = 'completion-modal-css';
            style.innerHTML = css;
            document.head.appendChild(style);
        }

        // Authentication Functions
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const role = localStorage.getItem('user_role');
            
            if (!token || !role) {
                window.location.href = '/login';
                return;
            }
            
            // Update username display
            document.getElementById('user-username').textContent = localStorage.getItem('username') || 'User';
        }

        function logout() {
            // Set logout flag to prevent any ongoing API calls
            isLoggingOut = true;
            
            // Show immediate visual feedback
            const logoutButton = document.querySelector('a[onclick="logout()"]');
            if (logoutButton) {
                logoutButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Logging out...';
                logoutButton.style.pointerEvents = 'none';
            }
            
            // Clear all background intervals to prevent ongoing API calls
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
                messageRefreshInterval = null;
            }
            if (marketDataInterval) {
                clearInterval(marketDataInterval);
                marketDataInterval = null;
            }
            
            // Clear localStorage immediately
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');
            
            // Cancel any pending fetch requests by overriding fetch temporarily
            const originalFetch = window.fetch;
            window.fetch = () => Promise.reject(new Error('Logout in progress'));
            
            // Remove all event listeners that might cause delays
            window.removeEventListener('beforeunload', function() {});
            
            // Force immediate redirect - use multiple methods for maximum compatibility
            try {
                // Method 1: Direct redirect (fastest)
                window.location.replace('/login');
            } catch (e) {
                try {
                    // Method 2: Fallback to href
            window.location.href = '/login';
                } catch (e2) {
                    // Method 3: Last resort - reload to login
                    window.location = '/login';
                }
            }
        }

        async function initializeDashboard() {
            console.log('Starting initializeDashboard');
            // Show loading states
            showLoadingStates();
            
            try {
                console.log('Starting optimized dashboard loading');
                
                // Load critical data first (fast)
                await Promise.all([
                    updateStatus(),
                    loadAppConfiguration()
                ]);
                
                console.log('Critical data loaded, starting secondary data');
                
                // Load signals first (most important for user experience)
                await loadSignals();
                
                // Load other secondary data in parallel (can be slower)
                const otherPromises = [
                    populateSymbolDropdown(),
                    loadMarketData()
                ];
                
                // Wait for symbols dropdown to load (important for user experience)
                await Promise.all(otherPromises);
                
                console.log('Signals loaded, other data loading in background');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            } finally {
                console.log('Hiding loading states');
                // Always hide loading states, even if some API calls failed
                hideLoadingStates();
            }
        }

        async function loadAppConfiguration() {
            try {
                // Load both trading and app configuration
                const [tradingResponse, appResponse] = await Promise.all([
                    fetch('/api/config/trading'),
                    fetch('/api/config/app')
                ]);
                
                if (tradingResponse.ok) {
                    const config = await tradingResponse.json();
                    const tradingConfig = config.config;
                    
                    // Update app configuration with loaded values
                    if (tradingConfig.sentiment_thresholds) {
                        appConfig.sentimentThresholds = tradingConfig.sentiment_thresholds;
                    }
                    if (tradingConfig.signals && tradingConfig.signals.thresholds) {
                        if (tradingConfig.signals.thresholds.buy_threshold !== undefined) {
                            appConfig.thresholds.buy_threshold = tradingConfig.signals.thresholds.buy_threshold;
                        }
                        if (tradingConfig.signals.thresholds.sell_threshold !== undefined) {
                            appConfig.thresholds.sell_threshold = tradingConfig.signals.thresholds.sell_threshold;
                        }
                    }
                    if (tradingConfig.signals && tradingConfig.signals.weights) {
                        if (tradingConfig.signals.weights.technical_weight !== undefined) {
                            appConfig.thresholds.technical_weight = tradingConfig.signals.weights.technical_weight;
                        }
                        if (tradingConfig.signals.weights.sentiment_weight !== undefined) {
                            appConfig.thresholds.sentiment_weight = tradingConfig.signals.weights.sentiment_weight;
                        }
                    }
                    if (tradingConfig.universe && tradingConfig.universe.timeframes) {
                        appConfig.timeframes = tradingConfig.universe.timeframes;
                    }
                    if (tradingConfig.universe && tradingConfig.universe.timeframe) {
                        appConfig.default_timeframe = tradingConfig.universe.timeframe;
                    }
                    if (tradingConfig.technical_analysis) {
                        appConfig.technical_analysis = tradingConfig.technical_analysis;
                    }
                    if (tradingConfig.risk_management) {
                        appConfig.risk_management = tradingConfig.risk_management;
                    }
                    if (tradingConfig.sentiment_analysis) {
                        appConfig.sentiment_analysis = tradingConfig.sentiment_analysis;
                    }
                    
                    console.log('Loaded trading configuration:', appConfig);
                }
                
                // Load UI configuration from app config
                if (appResponse.ok) {
                    const appConfigData = await appResponse.json();
                    const systemConfig = appConfigData.config.system_config;
                    
                    if (systemConfig) {
                        // Update refresh intervals from configuration
                        appConfig.refresh_interval_seconds = systemConfig.refresh_interval_seconds || 60;
                        appConfig.auto_refresh_enabled = systemConfig.auto_refresh_enabled !== false;
                        
                        console.log('‚úÖ Loaded UI configuration - refresh interval:', appConfig.refresh_interval_seconds, 'seconds');
                        console.log('‚úÖ Auto refresh enabled:', appConfig.auto_refresh_enabled);
                    }
                }
                
                // Update UI with loaded configuration
                await updateUIWithConfiguration();
            } catch (error) {
                console.error('Error loading app configuration:', error);
            }
        }

        async function updateUIWithConfiguration() {
            // Update form placeholders and help text
            const buyThresholdInput = document.getElementById('buy-threshold-input');
            const sellThresholdInput = document.getElementById('sell-threshold-input');
            const techWeightInput = document.getElementById('tech-weight-input');
            const sentimentWeightInput = document.getElementById('sentiment-weight-input');
            const timeframeSelect = document.getElementById('timeframe-input');
            
            if (buyThresholdInput) {
                buyThresholdInput.placeholder = appConfig.thresholds.buy_threshold.toString();
                buyThresholdInput.setAttribute('title', `Buy signal threshold (-1 to 1, leave empty for default ${appConfig.thresholds.buy_threshold})`);
                const helpText = buyThresholdInput.parentElement.querySelector('.form-text');
                if (helpText) {
                    helpText.textContent = `Leave empty to use default (${appConfig.thresholds.buy_threshold})`;
                }
                // Pre-fill with default value if field is empty
                if (buyThresholdInput.value === '') {
                    buyThresholdInput.value = appConfig.thresholds.buy_threshold.toString();
                }
            }
            
            if (sellThresholdInput) {
                sellThresholdInput.placeholder = appConfig.thresholds.sell_threshold.toString();
                sellThresholdInput.setAttribute('title', `Sell signal threshold (-1 to 1, leave empty for default ${appConfig.thresholds.sell_threshold})`);
                const helpText = sellThresholdInput.parentElement.querySelector('.form-text');
                if (helpText) {
                    helpText.textContent = `Leave empty to use default (${appConfig.thresholds.sell_threshold})`;
                }
                // Pre-fill with default value if field is empty
                if (sellThresholdInput.value === '') {
                    sellThresholdInput.value = appConfig.thresholds.sell_threshold.toString();
                }
            }
            
            if (techWeightInput) {
                techWeightInput.placeholder = appConfig.thresholds.technical_weight.toString();
                techWeightInput.setAttribute('title', `Weight for technical analysis (0 to 1, leave empty for default ${appConfig.thresholds.technical_weight})`);
                const helpText = techWeightInput.parentElement.querySelector('.form-text');
                if (helpText) {
                    helpText.textContent = `Leave empty to use default (${appConfig.thresholds.technical_weight})`;
                }
                // Pre-fill with default value if field is empty
                if (techWeightInput.value === '') {
                    techWeightInput.value = appConfig.thresholds.technical_weight.toString();
                }
            }
            
            if (sentimentWeightInput) {
                sentimentWeightInput.placeholder = appConfig.thresholds.sentiment_weight.toString();
                sentimentWeightInput.setAttribute('title', `Weight for sentiment analysis (0 to 1, leave empty for default ${appConfig.thresholds.sentiment_weight})`);
                const helpText = sentimentWeightInput.parentElement.querySelector('.form-text');
                if (helpText) {
                    helpText.textContent = `Leave empty to use default (${appConfig.thresholds.sentiment_weight})`;
                }
                // Pre-fill with default value if field is empty
                if (sentimentWeightInput.value === '') {
                    sentimentWeightInput.value = appConfig.thresholds.sentiment_weight.toString();
                }
            }
            
            // Update timeframe options from fast symbols config
            if (timeframeSelect) {
                timeframeSelect.innerHTML = '';
                
                // Fetch timeframes from fast symbols endpoint
                try {
                    const response = await fetch('/api/config/symbols');
                    if (response.ok) {
                        const symbolsConfig = await response.json();
                        
                        if (symbolsConfig.timeframes) {
                            symbolsConfig.timeframes.forEach(timeframe => {
                                const option = document.createElement('option');
                                option.value = timeframe;
                                option.textContent = timeframe;
                                if (timeframe === (symbolsConfig.default_timeframe || '5m')) {
                                    option.selected = true;
                                }
                                timeframeSelect.appendChild(option);
                            });
                        } else {
                            // Fallback timeframes
                            const fallbackTimeframes = ['1m', '5m', '15m', '1h', '4h', '1d'];
                            fallbackTimeframes.forEach(timeframe => {
                                const option = document.createElement('option');
                                option.value = timeframe;
                                option.textContent = timeframe;
                                if (timeframe === '5m') {
                                    option.selected = true;
                                }
                                timeframeSelect.appendChild(option);
                            });
                        }
                    } else {
                        throw new Error('Failed to fetch symbols config');
                    }
                } catch (error) {
                    console.error('Error loading timeframes from symbols config:', error);
                    // Fallback timeframes
                    const fallbackTimeframes = ['1m', '5m', '15m', '1h', '4h', '1d'];
                    fallbackTimeframes.forEach(timeframe => {
                        const option = document.createElement('option');
                        option.value = timeframe;
                        option.textContent = timeframe;
                        if (timeframe === '5m') {
                            option.selected = true;
                        }
                        timeframeSelect.appendChild(option);
                    });
                }
            }
            
            // Update tooltips with configuration values
            updateTooltipsWithConfiguration();
            
            // Update help text with configuration values
            updateHelpTextWithConfiguration();
            
            // Restart refresh intervals with new configuration
            restartRefreshIntervals();
        }
        
        function restartRefreshIntervals() {
            // Clear existing intervals
            if (marketDataInterval) {
                clearInterval(marketDataInterval);
                marketDataInterval = null;
            }
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
                messageRefreshInterval = null;
            }
            
            // Restart intervals with new configuration
            if (appConfig.auto_refresh_enabled) {
                startMarketDataUpdates();
                startMessageRefresh();
                console.log('üîÑ Refresh intervals restarted with new configuration');
                console.log('üîÑ Market data interval:', appConfig.refresh_interval_seconds, 'seconds');
                console.log('üîÑ Message refresh interval:', appConfig.refresh_interval_seconds, 'seconds');
            } else {
                console.log('‚ö†Ô∏è Auto refresh is disabled in configuration');
            }
        }

        function updateTooltipsWithConfiguration() {
            // Update buy threshold tooltip
            const buyTooltip = document.querySelector('[data-bs-original-title*="Minimum fused score for BUY signals"]');
            if (buyTooltip) {
                buyTooltip.setAttribute('data-bs-original-title', 
                    `Minimum fused score for BUY signals. Range: 0.1-1.0. Higher = more conservative. Default: ${appConfig.thresholds.buy_threshold}`);
            }
            
            // Update sell threshold tooltip
            const sellTooltip = document.querySelector('[data-bs-original-title*="Maximum fused score for SELL signals"]');
            if (sellTooltip) {
                sellTooltip.setAttribute('data-bs-original-title', 
                    `Maximum fused score for SELL signals. Range: -1.0 to -0.1. More negative = more conservative. Default: ${appConfig.thresholds.sell_threshold}`);
            }
            
            // Update technical weight tooltip
            const techTooltip = document.querySelector('[data-bs-original-title*="How much technical indicators"]');
            if (techTooltip) {
                techTooltip.setAttribute('data-bs-original-title', 
                    `How much technical indicators (RSI, MACD) influence the signal. Range: 0.0-1.0. Must add up to 1.0 with sentiment weight. Default: ${appConfig.thresholds.technical_weight}`);
            }
            
            // Update sentiment weight tooltip
            const sentimentTooltip = document.querySelector('[data-bs-original-title*="How much news sentiment analysis"]');
            if (sentimentTooltip) {
                sentimentTooltip.setAttribute('data-bs-original-title', 
                    `How much news sentiment analysis influences the signal. Range: 0.0-1.0. Must add up to 1.0 with technical weight. Default: ${appConfig.thresholds.sentiment_weight}`);
            }
        }

        function updateHelpTextWithConfiguration() {
            // Update ATR multipliers
            const atrStopMultiplier = document.getElementById('atr-stop-multiplier');
            const atrTpMultiplier = document.getElementById('atr-tp-multiplier');
            if (atrStopMultiplier && appConfig.risk_management.atr_stop_multiplier) {
                atrStopMultiplier.textContent = appConfig.risk_management.atr_stop_multiplier;
            }
            if (atrTpMultiplier && appConfig.risk_management.atr_take_profit_multiplier) {
                atrTpMultiplier.textContent = appConfig.risk_management.atr_take_profit_multiplier;
            }
            
            // Update sentiment model name
            const sentimentModelName = document.getElementById('sentiment-model-name');
            if (sentimentModelName && appConfig.sentiment_analysis.model_name) {
                sentimentModelName.textContent = appConfig.sentiment_analysis.model_name;
            }
            
            // Update sentiment sources
            const sentimentSources = document.getElementById('sentiment-sources');
            if (sentimentSources && appConfig.sentiment_analysis.rss_feeds) {
                const sources = appConfig.sentiment_analysis.rss_feeds.length > 0 ? 
                    'Google News RSS feeds' : 'News feeds';
                sentimentSources.textContent = sources;
            }
        }

        // Cache for symbol data to avoid repeated API calls
        let symbolCache = null;
        let symbolCacheTime = 0;
        const SYMBOL_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        async function populateSymbolDropdown(retryCount = 0) {
            console.log('Starting populateSymbolDropdown, attempt:', retryCount + 1);
            const symbolSelect = document.getElementById('symbol-input');
            if (!symbolSelect) {
                console.error('Symbol select element not found');
                return;
            }
            
            symbolSelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a market...';
            symbolSelect.appendChild(defaultOption);
            
            try {
                console.log('Fetching symbols from fast symbols API...');
                const response = await fetch('/api/config/symbols');
                
                console.log('API response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const symbolsConfig = await response.json();
                console.log('Symbols API response data:', symbolsConfig);
                
                if (!symbolsConfig.crypto_symbols && !symbolsConfig.stock_symbols) {
                    console.error('No symbols found in response:', symbolsConfig);
                    throw new Error('No symbols configuration found');
                }
                
                console.log('Symbols configuration found:', symbolsConfig);
                
                // Combine crypto and stock symbols
                const allSymbols = [
                    ...(symbolsConfig.crypto_symbols || []),
                    ...(symbolsConfig.stock_symbols || [])
                ];
                
                console.log('Successfully fetched symbols from universe:', allSymbols);
                
                // Add symbols to dropdown
                allSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                    symbolSelect.appendChild(option);
                });
                
                // Set first symbol as default
                if (allSymbols.length > 0) {
                    symbolSelect.value = allSymbols[0];
                }
                
                console.log('Symbols dropdown populated successfully');
                
            } catch (error) {
                console.error('Error fetching config:', error);
                
                // Retry up to 3 times with increasing delay
                if (retryCount < 3) {
                    console.log(`Retrying in ${(retryCount + 1) * 1000}ms...`);
                    setTimeout(() => {
                        populateSymbolDropdown(retryCount + 1);
                    }, (retryCount + 1) * 1000);
                    return;
                }
                
                // Fallback to default symbols only after all retries failed
                console.log('Using fallback symbols after all retries failed');
                const fallbackSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'ADA/USDT', 'SOL/USDT'];
                
                fallbackSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                    symbolSelect.appendChild(option);
                });
                
                if (fallbackSymbols.length > 0) {
                    symbolSelect.value = fallbackSymbols[0];
                }
                
                console.log('Fallback symbols added');
            }
        }

        function populateDropdownFromCache(cacheData) {
            const symbolSelect = document.getElementById('symbol-input');
            const { activeSymbols } = cacheData;
            
            // Add all symbols with indicators
            const allSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'ADA/USDT', 'SOL/USDT'];
            
            allSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                
                // Add indicator for actively configured symbols
                if (activeSymbols.includes(symbol)) {
                    option.textContent = `${symbol} ‚úÖ (Active)`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = `${symbol} ‚ö†Ô∏è (May need API setup)`;
                    option.style.color = '#6c757d';
                }
                
                symbolSelect.appendChild(option);
            });
            
            // Set first active symbol as default if available
            if (activeSymbols.length > 0) {
                symbolSelect.value = activeSymbols[0];
            }
            
            // Update the active symbols count display
            document.getElementById('active-symbols').textContent = activeSymbols.length;
            document.getElementById('active-symbols').className = 'text-info'; // Reset color
        }

        function populateFallbackSymbols() {
            const symbolSelect = document.getElementById('symbol-input');
            // Use universe symbols as fallback
            const fallbackSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'ADA/USDT', 'SOL/USDT'];
            
            fallbackSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = `${symbol} ‚úÖ (Active)`;
                option.style.fontWeight = 'bold';
                symbolSelect.appendChild(option);
            });
            
            symbolSelect.value = fallbackSymbols[0];
            
            // Don't override the active symbols count if it's already been set by status API
            const currentCount = document.getElementById('active-symbols').textContent;
            if (currentCount === '' || currentCount === '0' || currentCount.includes('hourglass')) {
                document.getElementById('active-symbols').textContent = fallbackSymbols.length;
                document.getElementById('active-symbols').className = 'text-info';
            }
        }

        function startStatusUpdates() {
            statusUpdateInterval = setInterval(updateStatus, 5000); // Update every 5 seconds
            // Delay market data updates to prioritize critical data
            setTimeout(() => {
                startMarketDataUpdates();
            }, 2000); // Start market data after 2 seconds
        }
        
        function startMessageRefresh() {
            // Use configuration value for refresh interval (convert seconds to milliseconds)
            const refreshIntervalMs = (appConfig.refresh_interval_seconds || 60) * 1000;
            messageRefreshInterval = setInterval(() => {
                loadUserMessages(true); // Show loading indicator for auto-refresh
            }, refreshIntervalMs);
            console.log(`Message refresh interval set to ${appConfig.refresh_interval_seconds} seconds`);
        }


        async function updateStatus() {
            // Skip if logging out
            if (isLoggingOut) return;
            
            try {
                // Get authentication token for user-specific status
                const token = localStorage.getItem('auth_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/status', { headers });
                const status = await response.json();
                
                // Update status indicators
                document.getElementById('total-signals').textContent = status.total_trading_tips;
                document.getElementById('active-symbols').textContent = status.active_symbols.length;
                
                // Update maintenance notification
                updateMaintenanceNotification(status.maintenance_message);
                
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function updateMaintenanceNotification(message) {
            const notification = document.getElementById('maintenance-notification');
            const messageElement = document.getElementById('maintenance-message');
            
            if (message && message.trim() !== '') {
                // Show maintenance notification
                messageElement.textContent = message;
                notification.classList.remove('d-none');
                notification.classList.add('show');
            } else {
                // Hide maintenance notification
                notification.classList.add('d-none');
                notification.classList.remove('show');
            }
        }

        let isLoadingSignals = false; // Prevent concurrent requests

        async function loadSignals() {
            // Skip if logging out
            if (isLoggingOut) return;
            if (isLoadingSignals) {
                console.log('Signals already loading, skipping duplicate request');
                return;
            }
            
            isLoadingSignals = true;
            
            try {
                console.log('Starting loadSignals function');
                
                // Show loading state with progress bar
                const container = document.getElementById('signals-container');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <div class="spinner-border text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="text-muted">Loading recent tips...</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    `;
                }
                
                // Also update the header to show loading state
                const header = document.querySelector('.card-header h5');
                if (header) {
                    header.innerHTML = '<i class="bi bi-list-ul"></i> Recent Trading Tips <small class="text-muted">(Loading...)</small>';
                }
                
                // Get authentication token
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    console.error('No authentication token found');
                    displaySignals([]); // Show empty state
                    return;
                }
                console.log('Authentication token found, making API call');
                
                const response = await fetch('/api/signals', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const signals = await response.json();
                    console.log('Signals received:', signals.length, 'signals');
                    console.log('Signals data:', signals);
                    displaySignals(signals);
                } else if (response.status === 401) {
                    console.error('Authentication failed, redirecting to login');
                    window.location.href = '/login';
                } else {
                    console.error('Error loading signals:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    displaySignals([]); // Show empty state on error
                }
            } catch (error) {
                console.error('Error loading signals:', error);
                displaySignals([]); // Show empty state on any error
            } finally {
                isLoadingSignals = false; // Reset loading flag
            }
        }

        function displaySignals(signals) {
            console.log('displaySignals called with:', signals.length, 'signals');
            const container = document.getElementById('signals-container');
            console.log('Signals container found:', container);
            
            // Reset header to normal state
            const header = document.querySelector('.card-header h5');
            if (header) {
                header.innerHTML = '<i class="bi bi-list-ul"></i> Recent Trading Tips';
            }
            
            if (signals.length === 0) {
                console.log('No signals to display, showing empty message');
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-graph-up fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted mb-2">No Generated Tips</h5>
                        <p class="text-muted mb-3">No trading tips have been generated yet.</p>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Use the form above to create your first trading tip
                        </small>
                    </div>
                `;
                return;
            }
            
            console.log('Displaying', signals.length, 'signals');
            
            // Add compact header row
            let headerRow = `
                <div class="card mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body py-1">
                        <div class="row align-items-center text-center">
                            <div class="col-1">
                                <strong class="small text-white">#</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">Type</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Market</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">TF</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Time Created</strong>
                            </div>
                            <div class="col-1">
                                <strong class="small text-white">Confidence</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Score</strong>
                            </div>
                            <div class="col-2">
                                <strong class="small text-white">Actions</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = headerRow + signals.map((signal, index) => `
                <div class="card signal-card ${signal.signal_type.toLowerCase()} mb-2 border-${getSignalColor(signal.signal_type)} border-1 shadow-sm">

                    <div class="card-body py-2">
                        <div class="row align-items-center text-center">
                            <div class="col-1">
                                <span class="badge bg-secondary">${index + 1}</span>
                            </div>
                            <div class="col-1">
                                <span class="badge bg-${getSignalColor(signal.signal_type)}">${signal.signal_type}</span>
                            </div>
                            <div class="col-2">
                                <strong>${signal.symbol}</strong>
                            </div>
                            <div class="col-1">
                                <span class="badge bg-info">${signal.timeframe || appConfig.default_timeframe}</span>
                            </div>
                            <div class="col-2">
                                <small class="text-muted">${formatTimestamp(signal.timestamp)}</small>
                            </div>
                            <div class="col-1">
                                <strong>${(signal.confidence * 100).toFixed(1)}%</strong>
                            </div>
                            <div class="col-2">
                                <span class="badge bg-${getScoreBadgeColor(signal.fused_score)} text-white small px-2 py-1">
                                    ${signal.fused_score.toFixed(2)}
                                </span>
                            </div>
                            <div class="col-2 text-center">
                                <button class="btn btn-sm btn-outline-${getSignalColor(signal.signal_type)} small me-1" onclick="toggleSignalDetails('${signal.timestamp}')">
                                    <i class="bi bi-chevron-down" id="icon-${signal.timestamp}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger small" onclick="deleteSignal('${signal.timestamp}', '${signal.symbol}')" title="Delete Signal">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2 bg-light" id="details-${signal.timestamp}" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-2 border-bottom pb-1 small">üìä Signal Configuration</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Technical Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Combines RSI and MACD indicators. Range: -1 to +1. Positive = bullish momentum, Negative = bearish momentum. Calculated as: (RSI_score + MACD_score) / 2"></i>
                                        </small><br>
                                        <strong>${signal.technical_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Sentiment Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="News sentiment analysis using FinBERT model. Range: -1 to +1. Positive = bullish news, Negative = bearish news. Based on recent market headlines from Google News RSS feeds."></i>
                                        </small><br>
                                        <span class="badge ${getSentimentBadgeClass(signal.sentiment_score)}">
                                            ${formatSentimentDisplay(signal.sentiment_score)}
                                        </span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4">
                                        <small class="text-muted">
                                            Fused Score 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Final signal score combining technical and sentiment analysis. Formula: (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score). Range: -1 to +1. Used to determine BUY/SELL/HOLD signals."></i>
                                        </small><br>
                                        <strong>${signal.fused_score.toFixed(4)}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">
                                            Confidence 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Signal strength indicator. Calculated as absolute value of fused score. Range: 0% to 100%. Higher values indicate stronger conviction in the signal direction."></i>
                                        </small><br>
                                        <strong>${(signal.confidence * 100).toFixed(2)}%</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Timeframe</small><br>
                                        <strong class="text-info">${signal.timeframe || appConfig.default_timeframe}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-2 border-bottom pb-1 small">üõ°Ô∏è Risk Management</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Stop Loss 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Automatic exit price to limit losses. Calculated as: Current Price ¬± (2 √ó ATR). For BUY signals: Current Price - (2 √ó ATR). For SELL signals: Current Price + (2 √ó ATR). ATR = Average True Range (volatility measure)."></i>
                                        </small><br>
                                        <strong>${signal.stop_loss ? signal.stop_loss.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            Take Profit 
                                            <i class="bi bi-info-circle text-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Target profit exit price. Calculated as: Current Price ¬± (3 √ó ATR). For BUY signals: Current Price + (3 √ó ATR). For SELL signals: Current Price - (3 √ó ATR). Risk-reward ratio is 1:1.5 (2 ATR risk vs 3 ATR reward)."></i>
                                        </small><br>
                                        <strong>${signal.take_profit ? signal.take_profit.toFixed(2) : 'N/A'}</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Reasoning</small><br>
                                        <strong class="text-info">${signal.reasoning}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h6 class="text-warning mb-2 border-bottom pb-1 small">‚è∞ Timing & Context</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Generated At</small><br>
                                        <strong>${new Date(signal.timestamp).toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Signal ID</small><br>
                                        <strong class="text-muted">${signal.timestamp.split('T')[1].split('.')[0]}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-danger mb-2">Applied Thresholds</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">Buy Threshold</small><br>
                                        <strong class="text-success">‚â• ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : appConfig.thresholds.buy_threshold.toFixed(2)}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sell Threshold</small><br>
                                        <strong class="text-danger">‚â§ ${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : appConfig.thresholds.sell_threshold.toFixed(2)}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Tech Weight</small><br>
                                        <strong class="text-primary">${signal.applied_tech_weight !== null ? (signal.applied_tech_weight * 100).toFixed(0) : (appConfig.thresholds.technical_weight * 100).toFixed(0)}%</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Sentiment Weight</small><br>
                                        <strong class="text-info">${signal.applied_sentiment_weight !== null ? (signal.applied_sentiment_weight * 100).toFixed(0) : (appConfig.thresholds.sentiment_weight * 100).toFixed(0)}%</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Signal Logic</small><br>
                                        <strong class="text-secondary">
                                            ${signal.signal_type === 'BUY' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â• Buy Threshold (${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : appConfig.thresholds.buy_threshold.toFixed(2)})` :
                                                signal.signal_type === 'SELL' ? 
                                                `Fused Score (${signal.fused_score.toFixed(4)}) ‚â§ Sell Threshold (${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : appConfig.thresholds.sell_threshold.toFixed(2)})` :
                                                `Fused Score (${signal.fused_score.toFixed(4)}) between thresholds (${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : appConfig.thresholds.sell_threshold.toFixed(2)} to ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : appConfig.thresholds.buy_threshold.toFixed(2)})`
                                            }
                                            <br><small class="text-muted">Debug: buy=${signal.applied_buy_threshold}, sell=${signal.applied_sell_threshold}</small>
                                        </strong>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-info mb-0 border-bottom pb-1 small">üìà Signal History</h6>
                                    <button class="btn btn-sm btn-outline-info" onclick="toggleSignalHistory('${signal.timestamp}')" id="history-btn-${signal.timestamp}">
                                        <i class="bi bi-chevron-down" id="history-icon-${signal.timestamp}"></i>
                                    </button>
                                </div>
                                <div id="history-${signal.timestamp}" class="signal-history" style="display: none;">
                                    <div class="text-center py-2">
                                        <small class="text-muted">Loading history...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Initialize tooltips for all info icons
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function getSignalColor(signalType) {
            switch (signalType) {
                case 'BUY': return 'success';
                case 'SELL': return 'danger';
                case 'HOLD': return 'secondary';
                default: return 'secondary';
            }
        }
        
        function getScoreBadgeColor(score) {
            if (score >= appConfig.thresholds.buy_threshold) return 'success';
            if (score <= appConfig.thresholds.sell_threshold) return 'danger';
            return 'secondary';
        }

        // Configuration loaded from trading.yaml and app.yaml
        let appConfig = {
            sentimentThresholds: {
                positive_threshold: 0.1,
                negative_threshold: -0.1,
                neutral_range: [-0.1, 0.1]
            },
            thresholds: {
                buy_threshold: 0.5,
                sell_threshold: -0.5,
                technical_weight: 0.6,
                sentiment_weight: 0.4
            },
            timeframes: ["1m", "5m", "15m", "1h"],
            default_timeframe: "5m",
            technical_analysis: {
                rsi: { period: 14, overbought: 70, oversold: 30 },
                macd: { fast: 12, slow: 26, signal: 9 },
                atr: { period: 14, multiplier: 2.0 }
            },
            risk_management: {
                atr_stop_multiplier: 2.0,
                atr_take_profit_multiplier: 3.0
            },
            sentiment_analysis: {
                model_name: "ProsusAI/finbert",
                rss_feeds: ["Google News RSS feeds"],
                reddit_subreddits: ["CryptoCurrency", "Bitcoin", "ethereum", "investing", "stocks"]
            },
            // UI refresh configuration (loaded from app.yaml)
            refresh_interval_seconds: 60, // Default 1 minute
            auto_refresh_enabled: true
        };

        function interpretSentimentScore(score) {
            const { positive_threshold, negative_threshold, neutral_range } = appConfig.sentimentThresholds;
            
            if (score >= positive_threshold) {
                return {
                    category: "positive",
                    label: "Bullish",
                    color: "success",
                    icon: "bi-arrow-up-circle-fill",
                    description: `Strong positive sentiment (‚â•${positive_threshold})`
                };
            } else if (score <= negative_threshold) {
                return {
                    category: "negative",
                    label: "Bearish",
                    color: "danger",
                    icon: "bi-arrow-down-circle-fill",
                    description: `Strong negative sentiment (‚â§${negative_threshold})`
                };
            } else if (neutral_range[0] <= score && score <= neutral_range[1]) {
                return {
                    category: "neutral",
                    label: "Neutral",
                    color: "secondary",
                    icon: "bi-dash-circle-fill",
                    description: `Neutral sentiment (${neutral_range[0]} to ${neutral_range[1]})`
                };
            } else {
                if (score > 0) {
                    return {
                        category: "weakly_positive",
                        label: "Slightly Bullish",
                        color: "info",
                        icon: "bi-arrow-up-circle",
                        description: `Weak positive sentiment (${neutral_range[1]} to ${positive_threshold})`
                    };
                } else {
                    return {
                        category: "weakly_negative",
                        label: "Slightly Bearish",
                        color: "warning",
                        icon: "bi-arrow-down-circle",
                        description: `Weak negative sentiment (${negative_threshold} to ${neutral_range[0]})`
                    };
                }
            }
        }

        function formatSentimentDisplay(score) {
            // Ensure score is a number and handle null/undefined
            const numScore = parseFloat(score) || 0;
            const interpretation = interpretSentimentScore(numScore);
            return `<i class="bi ${interpretation.icon}"></i> ${interpretation.label} (${numScore.toFixed(3)})`;
        }

        function getSentimentBadgeClass(score) {
            // Ensure score is a number and handle null/undefined
            const numScore = parseFloat(score) || 0;
            const interpretation = interpretSentimentScore(numScore);
            return `bg-${interpretation.color}`;
        }

        function formatTimestamp(timestamp) {
            try {
                // Parse timestamp (should be in Israel timezone format)
                const date = new Date(timestamp);
                
                // Get current time in Israel timezone
                const now = new Date();
                const israelNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
                const israelDate = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
                
                const diffMs = israelNow - israelDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'Just now';
                } else if (diffMins < 60) {
                    return `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    return `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    return `${diffDays}d ago`;
                } else {
                    // For older dates, show formatted date in Israel timezone
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Jerusalem'
                    });
                }
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return 'Unknown';
            }
        }
        
        function toggleSignalDetails(timestamp) {
            const detailsElement = document.getElementById(`details-${timestamp}`);
            const iconElement = document.getElementById(`icon-${timestamp}`);
            
            if (detailsElement && iconElement) {
                if (detailsElement.style.display === 'none') {
                    detailsElement.style.display = 'block';
                    iconElement.className = 'bi bi-chevron-up';
                    // Don't automatically load history - user needs to click history button
                } else {
                    detailsElement.style.display = 'none';
                    iconElement.className = 'bi bi-chevron-down';
                }
            }
        }

        function toggleSignalHistory(timestamp) {
            const historyElement = document.getElementById(`history-${timestamp}`);
            const historyIcon = document.getElementById(`history-icon-${timestamp}`);
            
            if (historyElement && historyIcon) {
                if (historyElement.style.display === 'none') {
                    historyElement.style.display = 'block';
                    historyIcon.className = 'bi bi-chevron-up';
                    // Load history when expanding
                    refreshSignalHistory(timestamp);
                } else {
                    historyElement.style.display = 'none';
                    historyIcon.className = 'bi bi-chevron-down';
                }
            }
        }

        async function deleteSignal(timestamp, symbol) {
            if (!confirm(`Are you sure you want to delete the signal for ${symbol}?`)) {
                return;
            }
            
            // Find the delete button and show loading state
            const deleteButton = document.querySelector(`button[onclick="deleteSignal('${timestamp}', '${symbol}')"]`);
            const originalContent = deleteButton ? deleteButton.innerHTML : '';
            
            try {
                // Show loading state on delete button
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Deleting...';
                    deleteButton.classList.add('btn-secondary');
                    deleteButton.classList.remove('btn-outline-danger');
                }
                
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Authentication required. Please login again.', 'error');
                    window.location.href = '/login';
                    return;
                }
                
                console.log(`Deleting signal for ${symbol} at ${timestamp}`);
                
                const response = await fetch(`/api/signals/${timestamp}?symbol=${encodeURIComponent(symbol)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    console.log('Signal deleted successfully');
                    showNotification('Signal deleted successfully!', 'success');
                    
                    // Show success state briefly before refreshing
                    if (deleteButton) {
                        deleteButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>Deleted!';
                        deleteButton.classList.remove('btn-secondary');
                        deleteButton.classList.add('btn-success');
                    }
                    
                    // Wait a moment to show success state, then refresh
                    setTimeout(async () => {
                    await loadSignals(); // Refresh the signals list
                    }, 1000);
                    
                } else {
                    const error = await response.json();
                    console.error('Delete failed:', error);
                    showNotification(`Failed to delete signal: ${error.detail || 'Unknown error'}`, 'error');
                    
                    // Reset button on error
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = originalContent;
                        deleteButton.classList.remove('btn-secondary');
                        deleteButton.classList.add('btn-outline-danger');
                    }
                }
            } catch (error) {
                console.error('Error deleting signal:', error);
                showNotification('Failed to delete signal. Please try again.', 'error');
                
                // Reset button on error
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    deleteButton.classList.remove('btn-secondary');
                    deleteButton.classList.add('btn-outline-danger');
                }
            }
        }

        function resetThresholds() {
            // Reset all threshold input fields to empty
            document.getElementById('buy-threshold-input').value = '';
            document.getElementById('sell-threshold-input').value = '';
            document.getElementById('tech-weight-input').value = '';
            document.getElementById('sentiment-weight-input').value = '';
            
            showNotification('Thresholds reset to defaults', 'info');
        }

        async function refreshSignalHistory(timestamp) {
            const historyElement = document.getElementById(`history-${timestamp}`);
            if (!historyElement) return;
            
            // Show loading indicator
            historyElement.innerHTML = `
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="text-muted">Refreshing history...</small>
                </div>
            `;
            
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    console.error('No auth token found');
                    historyElement.innerHTML = '<div class="text-center py-2"><small class="text-danger">Authentication required</small></div>';
                    return;
                }

                const response = await fetch(`/api/signals/${timestamp}/history`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySignalHistory(timestamp, data.history);
                } else {
                    console.error('Failed to load signal history:', response.status);
                    historyElement.innerHTML = 
                        '<div class="text-center py-2"><small class="text-muted">No history available</small></div>';
                }
            } catch (error) {
                console.error('Error loading signal history:', error);
                historyElement.innerHTML = 
                    '<div class="text-center py-2"><small class="text-danger">Error loading history</small></div>';
            }
        }

        async function loadSignalHistory(timestamp) {
            // This function is kept for backward compatibility
            await refreshSignalHistory(timestamp);
        }

        function displaySignalHistory(timestamp, history) {
            const historyElement = document.getElementById(`history-${timestamp}`);
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<div class="text-center py-2"><small class="text-muted">No history events yet</small></div>';
                return;
            }

            const historyHTML = history.map(event => {
                const eventTime = new Date(event.timestamp).toLocaleString('en-US', {
                    timeZone: 'Asia/Jerusalem',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let eventIcon = 'üìù';
                let eventColor = 'secondary';
                
                switch (event.event_type) {
                    case 'signal_created':
                        eventIcon = 'üÜï';
                        eventColor = 'success';
                        break;
                    case 'status_changed':
                        eventIcon = 'üîÑ';
                        eventColor = 'warning';
                        break;
                    case 'threshold_updated':
                        eventIcon = '‚öôÔ∏è';
                        eventColor = 'info';
                        break;
                    case 'market_data_refreshed':
                        eventIcon = 'üìä';
                        eventColor = 'primary';
                        break;
                    case 'monitoring_cycle':
                        eventIcon = 'üîç';
                        eventColor = 'secondary';
                        break;
                    default:
                        eventIcon = 'üìù';
                        eventColor = 'secondary';
                        break;
                }

                // Format metadata in a single line - only show essential fields
                let metadataText = '';
                if (event.metadata && Object.keys(event.metadata).length > 0) {
                    const metadata = event.metadata;
                    const parts = [];
                    
                    // Add fused score if available
                    if (metadata.fused_score !== undefined && metadata.fused_score !== null) {
                        const fusedScore = typeof metadata.fused_score === 'number' ? metadata.fused_score.toFixed(4) : metadata.fused_score;
                        parts.push(`FUSED SCORE: ${fusedScore}`);
                    }
                    
                    // Add technical score if available
                    if (metadata.technical_score !== undefined && metadata.technical_score !== null) {
                        const technicalScore = typeof metadata.technical_score === 'number' ? metadata.technical_score.toFixed(4) : metadata.technical_score;
                        parts.push(`TECHNICAL SCORE: ${technicalScore}`);
                    }
                    
                    // Add sentiment score if available
                    if (metadata.sentiment_score !== undefined && metadata.sentiment_score !== null) {
                        const sentimentScore = typeof metadata.sentiment_score === 'number' ? metadata.sentiment_score.toFixed(4) : metadata.sentiment_score;
                        parts.push(`SENTIMENT SCORE: ${sentimentScore}`);
                    }
                    
                    // Add current status (signal type) if available
                    if (metadata.signal_type) {
                        parts.push(`CURRENT STATUS: ${metadata.signal_type}`);
                    }
                    
                    if (parts.length > 0) {
                        metadataText = parts.join(' | ');
                    }
                }

                return `
                    <div class="d-flex align-items-center mb-1 p-2 border-start border-3 border-${eventColor} bg-light rounded">
                        <div class="me-2">
                            <span class="fs-6">${eventIcon}</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <strong class="text-${eventColor} small me-2">${event.description}</strong>
                                    ${metadataText ? `<span class="text-muted small">${metadataText}</span>` : ''}
                            </div>
                                <small class="text-muted ms-2">${eventTime}</small>
                                </div>
                        </div>
                    </div>
                `;
            }).join('');

            historyElement.innerHTML = historyHTML;
            
            // Initialize tooltips for any info icons in the history
            const tooltipTriggerList = [].slice.call(historyElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        

        async function generateSignal() {
            const symbol = document.getElementById('symbol-input').value;
            const timeframe = document.getElementById('timeframe-input').value;
            
            if (!symbol) {
                alert('Please select a market from the dropdown');
                return;
            }
            
            if (!timeframe) {
                alert('Please select a timeframe from the dropdown');
                return;
            }
            
            // Show impressive AI-powered loading animation
            const generateBtn = document.querySelector('button[onclick="generateSignal()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="bi bi-cpu"></i> AI Analyzing...';
            generateBtn.disabled = true;
            
            // Create and show AI analysis modal
            const aiModalPromise = showAIAnalysisModal(symbol, timeframe);
            
            // Debug: Check form values immediately
            console.log('Form values at start of generateSignal:', {
                buyThreshold: document.getElementById('buy-threshold-input').value,
                sellThreshold: document.getElementById('sell-threshold-input').value,
                techWeight: document.getElementById('tech-weight-input').value,
                sentimentWeight: document.getElementById('sentiment-weight-input').value
            });
            
            // Get custom threshold values (empty strings become null for backend)
            const buyThresholdElement = document.getElementById('buy-threshold-input');
            const sellThresholdElement = document.getElementById('sell-threshold-input');
            const techWeightElement = document.getElementById('tech-weight-input');
            const sentimentWeightElement = document.getElementById('sentiment-weight-input');
            
            // Debug logging - check if elements exist
            console.log('Form elements found:', {
                buyThresholdElement: buyThresholdElement ? 'Found' : 'NOT FOUND',
                sellThresholdElement: sellThresholdElement ? 'Found' : 'NOT FOUND',
                techWeightElement: techWeightElement ? 'Found' : 'NOT FOUND',
                sentimentWeightElement: sentimentWeightElement ? 'Found' : 'NOT FOUND'
            });
            
            // Debug logging - check element details
            if (buyThresholdElement) {
                console.log('Buy threshold element details:', {
                    id: buyThresholdElement.id,
                    value: buyThresholdElement.value,
                    placeholder: buyThresholdElement.placeholder,
                    type: buyThresholdElement.type
                });
            }
            
            const buyThreshold = buyThresholdElement ? buyThresholdElement.value : '';
            const sellThreshold = sellThresholdElement ? sellThresholdElement.value : '';
            const techWeight = techWeightElement ? techWeightElement.value : '';
            const sentimentWeight = sentimentWeightElement ? sentimentWeightElement.value : '';
            
            // Debug logging
            console.log('Form values:', {
                buyThreshold,
                sellThreshold,
                techWeight,
                sentimentWeight
            });
            
            // Prepare request payload with actual values (pre-filled defaults or user overrides)
            const payload = {
                symbol,
                timeframe,
                buy_threshold: parseFloat(buyThreshold),
                sell_threshold: parseFloat(sellThreshold),
                technical_weight: parseFloat(techWeight),
                sentiment_weight: parseFloat(sentimentWeight)
            };
            
            // Debug logging
            console.log('Payload being sent:', payload);
            

            try {
                // Get authentication token
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Authentication required. Please login again.', 'error');
                    window.location.href = '/login';
                    return;
                }
                
                // Start the API call immediately (don't wait for animation)
                const apiPromise = fetch('/api/signals/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                // Wait for both animation and API call to complete
                const [animationResult, response] = await Promise.all([aiModalPromise, apiPromise]);
                
                if (response.ok) {
                    const signal = await response.json();
                    
                    // Hide AI analysis modal first
                    hideAIAnalysisModal();
                    
                    // Show completion popup
                    showSignalCompletionModal(signal);
                    
                    // Don't refresh signals here - let user click OK to refresh
                    
                    // Show success message
                    showNotification('Trading tip generated successfully!', 'success');
                } else {
                    const error = await response.json();
                    let errorMessage = 'Unknown error occurred';
                    let errorTitle = 'Error';
                    
                    // Handle different types of errors
                    if (typeof error.detail === 'object' && error.detail.error) {
                        // New structured error format
                        errorTitle = error.detail.error;
                        errorMessage = error.detail.message;
                        
                        // Show detailed popup for data availability issues
                        if (error.detail.error === 'Data Unavailable') {
                            showDataUnavailableModal(error.detail);
                            hideAIAnalysisModal();
                            return;
                        }
                    } else if (typeof error.detail === 'string') {
                        // Legacy string error format
                        errorMessage = error.detail;
                        
                        // Provide helpful error messages for common issues
                        if (errorMessage.includes('Could not fetch market data')) {
                            errorMessage = `Unable to fetch market data for ${symbol}. This symbol may not be supported by your current data providers.`;
                        } else if (errorMessage.includes('API key') || errorMessage.includes('authentication')) {
                            errorMessage = `Authentication error. Please check your API keys for ${symbol}.`;
                        }
                    }
                    
                    showNotification(`${errorTitle}: ${errorMessage}`, 'error');
                    // Hide modal on API error
                    hideAIAnalysisModal();
                }
            } catch (error) {
                console.error('Error generating signal:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
                // Hide modal on error
                hideAIAnalysisModal();
            } finally {
                // Reset button state (modal is already hidden by animation)
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function showDataUnavailableModal(errorDetail) {
            // Create data unavailable modal HTML
            const modalHTML = `
                <div class="modal fade" id="dataUnavailableModal" tabindex="-1" aria-labelledby="dataUnavailableModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="dataUnavailableModalLabel">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Data Unavailable
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-danger" role="alert">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-x-circle-fill me-2"></i>
                                        Cannot Generate Trading Signal
                                    </h6>
                                    <p class="mb-0">${errorDetail.message}</p>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-info-circle me-2"></i>Request Details</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Symbol:</strong> ${errorDetail.symbol}</li>
                                            <li><strong>Timeframe:</strong> ${errorDetail.timeframe}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-lightbulb me-2"></i>Suggestions</h6>
                                        <p class="mb-2">${errorDetail.suggestion}</p>
                                        <ul class="small">
                                            <li>Check if the symbol is correct</li>
                                            <li>Verify your API keys are configured</li>
                                            <li>Try a different symbol or timeframe</li>
                                            <li>Contact support if the issue persists</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6><i class="bi bi-gear me-2"></i>Configuration Help</h6>
                                    <div class="alert alert-info">
                                        <small>
                                            <strong>For Crypto:</strong> Ensure CCXT library is installed and exchange is configured.<br>
                                            <strong>For Stocks:</strong> Ensure Alpaca API keys are set in environment variables.
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-2"></i>Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('dataUnavailableModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('dataUnavailableModal'));
            modal.show();
            
            // Clean up modal when hidden
            document.getElementById('dataUnavailableModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function showSignalModal(signal) {
            const modalBody = document.getElementById('signal-modal-body');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Trading Tip Details</h6>
                        <p><strong>Market:</strong> ${signal.symbol}</p>
                        <p><strong>Recommendation:</strong> <span class="badge bg-${getSignalColor(signal.signal_type)}">${signal.signal_type}</span></p>
                        <p><strong>Confidence:</strong> ${(signal.confidence * 100).toFixed(1)}%</p>
                        <p><strong>Generated:</strong> ${new Date(signal.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Scores</h6>
                        <p><strong>Technical:</strong> ${signal.technical_score.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Combines RSI and MACD indicators. Range: -1 to +1. Positive = bullish momentum, Negative = bearish momentum. Calculated as: (RSI_score + MACD_score) / 2"></i>
                        </p>
                        <p><strong>Sentiment:</strong> 
                            <span class="badge ${getSentimentBadgeClass(signal.sentiment_score)}">
                                ${formatSentimentDisplay(signal.sentiment_score)}
                            </span>
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="News sentiment analysis using FinBERT model. Range: -1 to +1. Positive = bullish news, Negative = bearish news. Based on recent market headlines from Google News RSS feeds."></i>
                        </p>
                        <p><strong>Fused:</strong> ${signal.fused_score.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Final signal score combining technical and sentiment analysis. Formula: (Tech Weight √ó Technical Score) + (Sentiment Weight √ó Sentiment Score). Range: -1 to +1. Used to determine BUY/SELL/HOLD signals."></i>
                        </p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Risk Management</h6>
                        ${signal.stop_loss ? `<p><strong>Stop Loss:</strong> ${signal.stop_loss.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Automatic exit price to limit losses. Calculated as: Current Price ¬± (2 √ó ATR). For BUY signals: Current Price - (2 √ó ATR). For SELL signals: Current Price + (2 √ó ATR). ATR = Average True Range (volatility measure)."></i>
                        </p>` : ''}
                        ${signal.take_profit ? `<p><strong>Take Profit:</strong> ${signal.take_profit.toFixed(2)} 
                            <i class="bi bi-info-circle text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Target profit exit price. Calculated as: Current Price ¬± (3 √ó ATR). For BUY signals: Current Price + (3 √ó ATR). For SELL signals: Current Price - (3 √ó ATR). Risk-reward ratio is 1:1.5 (2 ATR risk vs 3 ATR reward)."></i>
                        </p>` : ''}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Applied Thresholds</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Buy Threshold:</strong> ${signal.applied_buy_threshold !== null ? signal.applied_buy_threshold.toFixed(2) : `Default (${appConfig.thresholds.buy_threshold})`}</p>
                                <p><strong>Sell Threshold:</strong> ${signal.applied_sell_threshold !== null ? signal.applied_sell_threshold.toFixed(2) : `Default (${appConfig.thresholds.sell_threshold})`}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Tech Weight:</strong> ${signal.applied_tech_weight !== null ? signal.applied_tech_weight.toFixed(2) : `Default (${appConfig.thresholds.technical_weight})`}</p>
                                <p><strong>Sentiment Weight:</strong> ${signal.applied_sentiment_weight !== null ? signal.applied_sentiment_weight.toFixed(2) : `Default (${appConfig.thresholds.sentiment_weight})`}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Reasoning</h6>
                        <p>${signal.reasoning}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('signalModal'));
            modal.show();
        }



        function runBacktest() {
            alert('Backtest functionality will be implemented in the CLI integration');
        }

        function runTune() {
            alert('Auto-tune functionality will be implemented in the CLI integration');
        }

        function runSchedule() {
            alert('Scheduler functionality will be implemented in the CLI integration');
        }


        // Loading state management
        function showLoadingStates() {
            // Show loading for total signals
            document.getElementById('total-signals').innerHTML = '<i class="bi bi-hourglass-split"></i>';
            document.getElementById('total-signals').className = 'text-muted';
            
            // Show loading for active symbols
            document.getElementById('active-symbols').innerHTML = '<i class="bi bi-hourglass-split"></i>';
            document.getElementById('active-symbols').className = 'text-muted';
            
            // Show loading for market dropdown
            const symbolSelect = document.getElementById('symbol-input');
            symbolSelect.innerHTML = '<option value="">Loading markets...</option>';
            symbolSelect.disabled = true;
            
            // Show loading for trading tips container
            const signalsContainer = document.getElementById('signals-container');
            signalsContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary me-2" role="status"><span class="visually-hidden">Loading...</span></div><span class="text-muted">Fetching trading tips...</span></div>';
        }

        function hideLoadingStates() {
            // Re-enable symbol dropdown
            const symbolSelect = document.getElementById('symbol-input');
            symbolSelect.disabled = false;
            
            // Clear loading state for signals container if it's still showing loading
            const signalsContainer = document.getElementById('signals-container');
            if (signalsContainer && signalsContainer.innerHTML.includes('Fetching trading tips')) {
                signalsContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-graph-up fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted mb-2">No Trading Tips Generated Yet</h5>
                        <p class="text-muted mb-3">Start by creating your first trading tip using the form above.</p>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Tips will appear here once you generate them
                        </small>
                    </div>
                `;
            }
        }

        // Market Data Functions
        
        let marketDataInterval = null;
        
        // Cache for market data to avoid multiple API calls
        let cachedMarketData = null;
        let marketDataCacheTime = 0;
        const MARKET_DATA_CACHE_DURATION = 30000; // 30 seconds cache
        
        async function loadMarketData() {
            // Skip if logging out
            if (isLoggingOut) return;
            
            try {
                // Show loading indicators for all market sections
                showMarketLoadingStates();
                
                // Load market data once and share it across all functions
                const marketData = await fetchMarketData();
                
                // Load all sections with the cached data
            await Promise.all([
                    loadPriceSummaryCards(marketData),
                    loadPerformanceRanking(marketData),
                    loadMarketStatistics(marketData)
                ]);
                
            } catch (error) {
                console.error('Error loading market data:', error);
                showMarketErrorStates();
            }
        }

        async function fetchMarketData() {
            // Check if we have recent cached data
            const now = Date.now();
            if (cachedMarketData && (now - marketDataCacheTime) < MARKET_DATA_CACHE_DURATION) {
                console.log('Using cached market data');
                return cachedMarketData;
            }

            console.log('Fetching fresh market data');
            const response = await fetch(`/api/market-data/all/overview?timeframe=${appConfig.default_timeframe || '5m'}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch market overview');
                }
                
                const marketData = await response.json();
            cachedMarketData = marketData;
            marketDataCacheTime = now;
            return marketData;
        }

        function showMarketLoadingStates() {
            // Show loading for price cards
            const cryptoContainer = document.getElementById('crypto-price-cards');
            const stockContainer = document.getElementById('stock-price-cards');
            if (cryptoContainer) {
                cryptoContainer.innerHTML = '<div class="col-12"><div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading crypto data...</span></div><br><small class="text-muted">Loading crypto data...</small></div></div>';
            }
            if (stockContainer) {
                stockContainer.innerHTML = '<div class="col-12"><div class="text-center py-4"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading stock data...</span></div><br><small class="text-muted">Loading stock data...</small></div></div>';
            }

            // Show loading for performance ranking
            const performanceContainer = document.getElementById('performance-ranking');
            if (performanceContainer) {
                performanceContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading performance data...</span></div><br><small class="text-muted">Loading performance data...</small></div>';
            }

            // Show loading for market statistics
            const statsContainer = document.getElementById('market-statistics');
            if (statsContainer) {
                statsContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading market statistics...</span></div><br><small class="text-muted">Loading market statistics...</small></div>';
            }
        }

        function showMarketErrorStates() {
            // Show error for price cards
            const cryptoContainer = document.getElementById('crypto-price-cards');
            const stockContainer = document.getElementById('stock-price-cards');
            if (cryptoContainer) {
                cryptoContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Failed to load crypto data</div></div>';
            }
            if (stockContainer) {
                stockContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Failed to load stock data</div></div>';
            }

            // Show error for performance ranking
            const performanceContainer = document.getElementById('performance-ranking');
            if (performanceContainer) {
                performanceContainer.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Failed to load performance data</div>';
            }

            // Show error for market statistics
            const statsContainer = document.getElementById('market-statistics');
            if (statsContainer) {
                statsContainer.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Failed to load market statistics</div>';
            }
        }
        
        async function loadPriceSummaryCards(marketData = null) {
            try {
                // Use provided market data or fetch if not provided
                if (!marketData) {
                    marketData = await fetchMarketData();
                }
                
                // Separate crypto and stock data
                const cryptoContainer = document.getElementById('crypto-price-cards');
                const stockContainer = document.getElementById('stock-price-cards');
                let cryptoHTML = '';
                let stockHTML = '';
                
                // Define crypto symbols (matching the trading.yaml config)
                const cryptoSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'ADA/USDT', 'SOL/USDT'];
                
                marketData.symbols.forEach(symbolData => {
                    const isCrypto = cryptoSymbols.includes(symbolData.symbol);
                    
                    if (symbolData.error) {
                        // Error card
                        const errorCard = `
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="card h-100 border-warning">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1">${symbolData.symbol}</h6>
                                        <p class="text-warning mb-0">${symbolData.error}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        if (isCrypto) {
                            cryptoHTML += errorCard;
                        } else {
                            stockHTML += errorCard;
                        }
                    } else {
                        const isPositive = symbolData.change >= 0;
                        const priceColor = isPositive ? 'success' : 'danger';
                        const iconClass = isCrypto ? 'bi-currency-bitcoin' : 'bi-graph-up';
                        
                        const priceCard = `
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="card h-100 ${isPositive ? 'border-success' : 'border-danger'} shadow-sm">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="bi ${iconClass} me-1"></i>${symbolData.symbol}
                                                </h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="h5 mb-0">$${symbolData.price.toFixed(2)}</span>
                                                    <span class="ms-2 badge bg-${priceColor}">
                                                        ${isPositive ? '+' : ''}${symbolData.change_percent.toFixed(2)}%
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    Change: ${isPositive ? '+' : ''}$${symbolData.change.toFixed(2)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <i class="bi bi-arrow-${isPositive ? 'up' : 'down'}-right text-${priceColor} fs-4"></i>
                                                <div class="mt-1">
                                                    <small class="text-muted">Vol: ${symbolData.volume.toLocaleString()}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        if (isCrypto) {
                            cryptoHTML += priceCard;
                        } else {
                            stockHTML += priceCard;
                        }
                    }
                });
                
                // Update containers
                if (cryptoContainer) {
                    cryptoContainer.innerHTML = cryptoHTML || '<div class="col-12"><div class="text-center text-muted py-4"><i class="bi bi-currency-bitcoin fs-1 mb-2"></i><br>No crypto data available</div></div>';
                }
                if (stockContainer) {
                    stockContainer.innerHTML = stockHTML || '<div class="col-12"><div class="text-center text-muted py-4"><i class="bi bi-graph-up fs-1 mb-2"></i><br>No stock data available</div></div>';
                }
                
                // Update last update times
                const lastCryptoUpdate = document.getElementById('last-crypto-update');
                const lastStockUpdate = document.getElementById('last-stock-update');
                const currentTime = new Date().toLocaleTimeString();
                
                if (lastCryptoUpdate) {
                    lastCryptoUpdate.textContent = currentTime;
                }
                if (lastStockUpdate) {
                    lastStockUpdate.textContent = currentTime;
                }
                
            } catch (error) {
                console.error('Error loading price summary cards:', error);
                const cryptoContainer = document.getElementById('crypto-price-cards');
                const stockContainer = document.getElementById('stock-price-cards');
                
                if (cryptoContainer) {
                    cryptoContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load crypto data</div></div>';
                }
                if (stockContainer) {
                    stockContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load stock data</div></div>';
                }
            }
        }

        
        async function loadPerformanceRanking(marketData = null) {
            try {
                // Use provided market data or fetch if not provided
                if (!marketData) {
                    marketData = await fetchMarketData();
                }
                const container = document.getElementById('performance-ranking');
                let rankingHTML = '';
                
                // Sort by performance
                const performances = marketData.symbols
                    .filter(s => !s.error)
                    .sort((a, b) => b.change_percent - a.change_percent);
                
                performances.forEach((perf, index) => {
                    const isPositive = perf.change_percent >= 0;
                    const rankClass = index === 0 ? 'text-warning' : index === 1 ? 'text-secondary' : index === 2 ? 'text-bronze' : '';
                    
                    rankingHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${index + 1}</span>
                                <span class="${rankClass}">${perf.symbol}</span>
                            </div>
                            <span class="badge bg-${isPositive ? 'success' : 'danger'}">
                                ${isPositive ? '+' : ''}${perf.change_percent.toFixed(2)}%
                            </span>
                        </div>
                    `;
                });
                
                container.innerHTML = rankingHTML || '<p class="text-muted">No performance data available</p>';
            } catch (error) {
                console.error('Error loading performance ranking:', error);
                const container = document.getElementById('performance-ranking');
                container.innerHTML = '<p class="text-warning">Error loading performance data</p>';
            }
        }
        
        async function loadMarketStatistics(marketData = null) {
            try {
                // Use provided market data or fetch if not provided
                if (!marketData) {
                    marketData = await fetchMarketData();
                }
                const container = document.getElementById('market-statistics');
                let statsHTML = '';
                
                // Calculate statistics from real data
                const validSymbols = marketData.symbols.filter(s => !s.error);
                const totalVolume = validSymbols.reduce((sum, s) => sum + s.volume, 0);
                const totalChange = validSymbols.reduce((sum, s) => sum + s.change_percent, 0);
                const symbolCount = validSymbols.length;
                
                const avgChange = symbolCount > 0 ? totalChange / symbolCount : 0;
                const marketSentiment = avgChange > 1 ? 'Bullish' : avgChange < -1 ? 'Bearish' : 'Neutral';
                const sentimentColor = avgChange > 1 ? 'success' : avgChange < -1 ? 'danger' : 'warning';
                
                // Calculate additional metrics
                const upSymbols = validSymbols.filter(s => s.change_percent > 0).length;
                const downSymbols = validSymbols.filter(s => s.change_percent < 0).length;
                const flatSymbols = validSymbols.filter(s => s.change_percent === 0).length;
                
                statsHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Market Sentiment</h6>
                                <span class="badge bg-${sentimentColor} fs-6">${marketSentiment}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted">Avg Change</h6>
                                <span class="badge bg-${avgChange >= 0 ? 'success' : 'danger'} fs-6">
                                    ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <div class="text-center mb-2">
                                <h6 class="text-muted">Symbol Performance</h6>
                                <div class="d-flex justify-content-around">
                                    <span class="badge bg-success">${upSymbols} Up</span>
                                    <span class="badge bg-danger">${downSymbols} Down</span>
                                    <span class="badge bg-secondary">${flatSymbols} Flat</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Active Symbols:</strong> ${symbolCount}<br>
                                <strong>Total Volume:</strong> ${totalVolume.toLocaleString()}<br>
                                <strong>Data Source:</strong> Live Market Data<br>
                                <strong>Last Update:</strong> ${new Date(marketData.timestamp).toLocaleTimeString()}
                            </small>
                        </div>
                    </div>
                `;
                
                container.innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading market statistics:', error);
                const container = document.getElementById('market-statistics');
                container.innerHTML = '<p class="text-warning">Error loading market statistics</p>';
            }
        }
        

        
        // Start market data updates
        function startMarketDataUpdates() {
            // Use configuration value for refresh interval (convert seconds to milliseconds)
            const refreshIntervalMs = (appConfig.refresh_interval_seconds || 60) * 1000;
            marketDataInterval = setInterval(loadMarketData, refreshIntervalMs);
            console.log(`Market data refresh interval set to ${appConfig.refresh_interval_seconds} seconds`);
        }
        
        
        // User Profile Functions
        async function showUserProfile() {
            console.log('showUserProfile called');
            
            // Show the modal immediately without waiting for any data
            console.log('Showing user profile modal immediately...');
            const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
            modal.show();
            console.log('User profile modal shown immediately');
            
            // Show loading state in the modal
            const modalBody = document.querySelector('#userProfileModal .modal-body');
            if (modalBody) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'profile-loading';
                loadingDiv.className = 'text-center py-3';
                loadingDiv.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading profile data...</p>
                `;
                modalBody.insertBefore(loadingDiv, modalBody.firstChild);
            }
            
            // Load profile data in the background (non-blocking)
            loadUserProfileData().catch(error => {
                console.error('Failed to load user profile data:', error);
                // Remove loading indicator on error
                const loadingDiv = document.getElementById('profile-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            });
            
            // Load Telegram connection status in the background (non-blocking)
            loadTelegramConnectionStatus().catch(error => {
                console.error('Failed to load Telegram connection status:', error);
            });
        }
        
        async function loadUserProfileData() {
            try {
                console.log('Fetching user profile data...');
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                console.log('User profile response status:', response.status);
                
                if (response.ok) {
                    const profile = await response.json();
                    
                    // Populate the form
                    document.getElementById('profile-username').value = profile.username || '';
                    document.getElementById('profile-role').value = profile.role || '';
                    document.getElementById('profile-first-name').value = profile.first_name || '';
                    document.getElementById('profile-last-name').value = profile.last_name || '';
                    document.getElementById('profile-email').value = profile.email || '';
                    document.getElementById('profile-phone').value = profile.phone || '';
                    document.getElementById('profile-additional-info').value = profile.additional_info || '';
                    document.getElementById('profile-created-at').value = profile.created_at ? new Date(profile.created_at).toLocaleString() : '';
                    document.getElementById('profile-last-login').value = profile.last_login ? new Date(profile.last_login).toLocaleString() : '';
                    document.getElementById('profile-status').value = profile.status || '';
                    
                    // Populate Telegram chat ID if available
                    if (profile.telegram_chat_id) {
                        const chatIdField = document.getElementById('telegram-chat-id');
                        if (chatIdField) {
                            chatIdField.value = profile.telegram_chat_id;
                        }
                    }
                    
                    // Format activation period
                    let activationText = 'N/A';
                    if (profile.activation_days !== null && profile.activation_days !== undefined) {
                        if (profile.activation_days === 0) {
                            activationText = 'Deactivated';
                        } else if (profile.activation_expires_at) {
                            const expiryDate = new Date(profile.activation_expires_at);
                            const now = new Date();
                            const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                            if (daysLeft > 0) {
                                activationText = `${daysLeft} days left (expires ${expiryDate.toLocaleDateString()})`;
                            } else {
                                activationText = 'Expired';
                            }
                        } else {
                            activationText = 'Permanent';
                        }
                    }
                    document.getElementById('profile-activation').value = activationText;
                    
                    // Remove loading indicator
                    const loadingDiv = document.getElementById('profile-loading');
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
                    
                    console.log('User profile data loaded successfully');
                } else {
                    const error = await response.json();
                    console.error('Error loading profile:', error.detail);
                    // Show error in the modal instead of alert
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-warning';
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error loading profile: ${error.detail}`;
                    document.querySelector('#userProfileModal .modal-body').insertBefore(errorDiv, document.querySelector('#userProfileModal .modal-body').firstChild);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                
                // Remove loading indicator
                const loadingDiv = document.getElementById('profile-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                
                // Show error in the modal
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                
                let errorMessage = error.message;
                
                errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error loading profile: ${errorMessage}`;
                document.querySelector('#userProfileModal .modal-body').insertBefore(errorDiv, document.querySelector('#userProfileModal .modal-body').firstChild);
            }
        }
        
        // Telegram Connection Functions
        async function loadTelegramConnectionStatus() {
            try {
                console.log('Loading Telegram connection status...');
                
                // Check if user is authenticated
                const authToken = localStorage.getItem('auth_token');
                if (!authToken) {
                    console.log('No auth token found, showing default Telegram form');
                    // Show default form when not authenticated
                    const statusDiv = document.getElementById('telegram-connection-status');
                    const formDiv = document.getElementById('telegram-connection-form');
                    
                    if (statusDiv && formDiv) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-telegram me-2 fs-5"></i>
                                    <div class="flex-grow-1">
                                        <strong>Telegram Not Connected</strong><br>
                                        <small class="text-muted">Connect your Telegram account to receive trading notifications</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        formDiv.classList.remove('d-none');
                    }
                    return;
                }
                
                const response = await fetch('/api/telegram/connection', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Telegram connection response status:', response.status);
                
                if (response.ok) {
                    const connection = await response.json();
                    console.log('Telegram connection data:', connection);
                    
                    const statusDiv = document.getElementById('telegram-connection-status');
                    const formDiv = document.getElementById('telegram-connection-form');
                    
                    if (!statusDiv || !formDiv) {
                        console.error('Telegram elements not found in DOM');
                        return;
                    }
                    
                    console.log('Connection status:', connection.connected);
                    if (connection.connected) {
                        // Populate the chat ID field with the stored value
                        const chatIdField = document.getElementById('telegram-chat-id');
                        if (chatIdField && connection.chat_id) {
                            chatIdField.value = connection.chat_id;
                        }
                        
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-telegram me-2 fs-5"></i>
                                    <div class="flex-grow-1">
                                        <strong>Telegram Connected</strong><br>
                                        <small class="text-muted">
                                            Chat ID: ${connection.chat_id}<br>
                                            Connected: ${connection.connected_at ? new Date(connection.connected_at).toLocaleString() : 'Unknown'}
                                        </small>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="testTelegramConnection()">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="disconnectTelegram()">
                                            <i class="bi bi-x-circle me-1"></i>Disconnect
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        formDiv.classList.add('d-none');
                    } else {
                        console.log('Showing disconnected state - form should be visible');
                        
                        // Check if there's a stored chat ID in the form field
                        const chatIdField = document.getElementById('telegram-chat-id');
                        const storedChatId = chatIdField ? chatIdField.value : '';
                        
                        statusDiv.innerHTML = `
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-telegram me-2 fs-5"></i>
                                    <div class="flex-grow-1">
                                        <strong>Telegram Not Connected</strong><br>
                                        <small class="text-muted">
                                            Connect your Telegram account to receive trading notifications
                                            ${storedChatId ? `<br><strong>Stored Chat ID:</strong> ${storedChatId}` : ''}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                        formDiv.classList.remove('d-none');
                        console.log('Form should now be visible');
                    }
                } else {
                    const error = await response.json();
                    console.error('Failed to load Telegram connection status:', error);
                    
                    // Show error state
                    const statusDiv = document.getElementById('telegram-connection-status');
                    const formDiv = document.getElementById('telegram-connection-form');
                    
                    if (statusDiv && formDiv) {
                        let errorMessage = 'Unable to load Telegram status';
                        let errorDetail = 'Please try refreshing the page';
                        
                        if (response.status === 401) {
                            errorMessage = 'Authentication required';
                            errorDetail = 'Please log in again to access Telegram settings';
                        } else if (response.status === 403) {
                            errorMessage = 'Access denied';
                            errorDetail = 'You do not have permission to access Telegram settings';
                        } else if (response.status >= 500) {
                            errorMessage = 'Server error';
                            errorDetail = 'Please try again later';
                        }
                        
                        statusDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-2 fs-5"></i>
                                    <div class="flex-grow-1">
                                        <strong>${errorMessage}</strong><br>
                                        <small class="text-muted">${errorDetail}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        formDiv.classList.remove('d-none');
                    }
                }
            } catch (error) {
                console.error('Error loading Telegram connection status:', error);
                
                // Show error state
                const statusDiv = document.getElementById('telegram-connection-status');
                const formDiv = document.getElementById('telegram-connection-form');
                
                if (statusDiv && formDiv) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle me-2 fs-5"></i>
                                <div class="flex-grow-1">
                                    <strong>Error loading Telegram status</strong><br>
                                    <small class="text-muted">Please check your connection and try again</small>
                                </div>
                            </div>
                        </div>
                    `;
                    formDiv.classList.remove('d-none');
                }
            }
        }
        
        async function showTelegramInstructions() {
            try {
                const response = await fetch('/api/telegram/instructions');
                if (response.ok) {
                    const data = await response.json();
                    
                    let instructionsHtml = `
                        <div class="modal fade" id="telegramInstructionsModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-telegram me-2"></i>How to Get Your Telegram Chat ID
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Note:</strong> ${data.note}
                                        </div>
                    `;
                    
                    data.instructions.forEach((instruction, index) => {
                        instructionsHtml += `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">${instruction.title}</h6>
                                </div>
                                <div class="card-body">
                                    <ol>
                                        ${instruction.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            </div>
                        `;
                    });
                    
                    instructionsHtml += `
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('telegramInstructionsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', instructionsHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('telegramInstructionsModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading Telegram instructions:', error);
                showNotification('Failed to load instructions', 'error');
            }
        }
        
        async function connectTelegram() {
            const chatId = document.getElementById('telegram-chat-id').value.trim();
            
            if (!chatId) {
                showNotification('Please enter your Telegram Chat ID', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/telegram/connect?chat_id=${encodeURIComponent(chatId)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Telegram connected successfully!', 'success');
                    document.getElementById('telegram-chat-id').value = '';
                    // Force immediate UI update
                    console.log('Telegram connected, refreshing status...');
                    // Small delay to ensure backend state is updated
                    setTimeout(async () => {
                        await loadTelegramConnectionStatus();
                        console.log('Telegram status refreshed after connection');
                    }, 100);
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to connect Telegram', 'error');
                }
            } catch (error) {
                console.error('Error connecting Telegram:', error);
                showNotification('Error connecting Telegram', 'error');
            }
        }
        
        async function disconnectTelegram() {
            if (!confirm('Are you sure you want to disconnect your Telegram account?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/telegram/disconnect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Telegram disconnected successfully', 'success');
                    // Force immediate UI update
                    console.log('Telegram disconnected, refreshing status...');
                    // Clear the chat ID input field
                    document.getElementById('telegram-chat-id').value = '';
                    // Small delay to ensure backend state is updated
                    setTimeout(async () => {
                        await loadTelegramConnectionStatus();
                        console.log('Telegram status refreshed after disconnection');
                    }, 200);
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to disconnect Telegram', 'error');
                }
            } catch (error) {
                console.error('Error disconnecting Telegram:', error);
                showNotification('Error disconnecting Telegram', 'error');
            }
        }
        
        async function testTelegramConnection() {
            try {
                console.log('Testing Telegram connection...');
                showNotification('Sending test message...', 'info');
                
                const response = await fetch('/api/telegram/test', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                console.log('Test response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Test successful:', result);
                    showNotification('‚úÖ Test message sent successfully! Check your Telegram.', 'success');
                } else {
                    const error = await response.json();
                    console.error('Test failed:', error);
                    
                    let errorMessage = 'Unknown error';
                    let helpMessage = '';
                    
                    if (response.status === 400) {
                        if (error.detail && error.detail.includes('No Telegram account connected')) {
                            errorMessage = 'No Telegram account connected';
                            helpMessage = 'Please connect your Telegram account first.';
                        } else if (error.detail && error.detail.includes('chat not found')) {
                            errorMessage = 'Telegram chat not found';
                            helpMessage = 'Follow these steps to get your Chat ID:\n\n' +
                                         '1Ô∏è‚É£ Open Telegram and search for @userinfobot\n' +
                                         '2Ô∏è‚É£ Start a conversation with @userinfobot\n' +
                                         '3Ô∏è‚É£ Send the command: /start\n' +
                                         '4Ô∏è‚É£ The bot will reply with your user information including chat ID\n' +
                                         '5Ô∏è‚É£ Copy the chat ID and enter it in your profile\n\n' +
                                         'Then come back here and click "Test" again.';
                        } else if (error.detail && error.detail.includes('bot was blocked')) {
                            errorMessage = 'Bot was blocked';
                            helpMessage = 'Please unblock @fh_tips_bot on Telegram and try again.';
                        } else if (error.detail && error.detail.includes('user is deactivated')) {
                            errorMessage = 'Telegram account deactivated';
                            helpMessage = 'Your Telegram account appears to be deactivated. Please check your Telegram account.';
                        } else if (error.detail && error.detail.includes('Failed to send Telegram message after 3 attempts')) {
                            errorMessage = 'Telegram connection failed';
                            helpMessage = 'Follow these steps to get your Chat ID:\n\n' +
                                         '1Ô∏è‚É£ Open Telegram and search for @userinfobot\n' +
                                         '2Ô∏è‚É£ Start a conversation with @userinfobot\n' +
                                         '3Ô∏è‚É£ Send the command: /start\n' +
                                         '4Ô∏è‚É£ The bot will reply with your user information including chat ID\n' +
                                         '5Ô∏è‚É£ Copy the chat ID and enter it in your profile\n\n' +
                                         'Then come back here and click "Test" again.';
                        } else {
                            errorMessage = error.detail || 'Bad request';
                            helpMessage = 'Please check your Telegram connection and try again.';
                        }
                    } else if (response.status === 500) {
                        errorMessage = 'Server error occurred';
                        helpMessage = 'There was a problem sending the message. Please try again later.';
                    } else if (response.status === 503) {
                        errorMessage = 'Telegram notifications disabled';
                        helpMessage = 'Telegram notifications are currently disabled by the administrator.';
                    } else {
                        errorMessage = error.detail || 'Unknown error';
                        helpMessage = 'Please try again or contact support if the problem persists.';
                    }
                    
                    showNotification(`‚ùå ${errorMessage}${helpMessage ? '\n\nüí° ' + helpMessage : ''}`, 'error');
                }
            } catch (error) {
                console.error('Error sending test message:', error);
                showNotification('‚ùå Network error. Please check your internet connection and try again.', 'error');
            }
        }
        
        async function updateUserProfile() {
            try {
                const profileData = {
                    first_name: document.getElementById('profile-first-name').value.trim() || null,
                    last_name: document.getElementById('profile-last-name').value.trim() || null,
                    email: document.getElementById('profile-email').value.trim() || null,
                    phone: document.getElementById('profile-phone').value.trim() || null,
                    additional_info: document.getElementById('profile-additional-info').value.trim() || null
                };
                
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Profile updated successfully!');
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userProfileModal'));
                    modal.hide();
                } else {
                    const error = await response.json();
                    alert('Error updating profile: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        }
        
        function showChangePassword() {
            // Clear the form
            document.getElementById('changePasswordForm').reset();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }
        
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('Please fill in all password fields');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long');
                    return;
                }
                
                const passwordData = {
                    current_password: currentPassword,
                    new_password: newPassword
                };
                
                const response = await fetch('/api/user/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(passwordData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Password changed successfully!');
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                } else {
                    const error = await response.json();
                    alert('Error changing password: ' + error.detail);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
            if (marketDataInterval) {
                clearInterval(marketDataInterval);
            }
        });

        // Contact Admin Functions
        
        function showContactAdminModal() {
            // Clear form
            document.getElementById('contact-subject').value = '';
            document.getElementById('contact-message').value = '';
            document.getElementById('contact-char-count').textContent = '0';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('contactAdminModal'));
            modal.show();
        }
        
        function showMessagesModal() {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
            modal.show();
            
            // Load messages
            loadUserMessages();
        }
        
        // Character count for contact message
        document.getElementById('contact-message').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('contact-char-count').textContent = count;
            
            if (count > 1000) {
                this.value = this.value.substring(0, 1000);
                document.getElementById('contact-char-count').textContent = '1000';
            }
        });
        
        async function sendMessageToAdmin() {
            try {
                const subject = document.getElementById('contact-subject').value.trim();
                const message = document.getElementById('contact-message').value.trim();
                
                if (!subject || !message) {
                    showNotification('Please fill in both subject and message fields.', 'error');
                    return;
                }
                
                if (message.length > 1000) {
                    showNotification('Message is too long. Maximum 1000 characters allowed.', 'error');
                    return;
                }
                
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to send messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/contact-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        subject: subject,
                        message: message
                    })
                });
                
                if (response.ok) {
                    showNotification('Message sent to admin successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('contactAdminModal'));
                    modal.hide();
                    
                    // Clear form
                    document.getElementById('contact-subject').value = '';
                    document.getElementById('contact-message').value = '';
                    document.getElementById('contact-char-count').textContent = '0';
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send message: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending message to admin:', error);
                showNotification('Failed to send message. Please try again.', 'error');
            }
        }
        
        // Prevent multiple simultaneous message refresh requests
        
        async function loadUserMessages(showLoadingIndicator = false) {
            // Prevent multiple simultaneous requests
            if (isLoadingMessages) {
                return;
            }
            
            try {
                isLoadingMessages = true;
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to view messages.', 'error');
                    return;
                }
                
                // Check if user is admin and use appropriate endpoint
                let userRole = localStorage.getItem('user_role') || 'user';
                let isAdmin = userRole === 'admin';
                
                // Only fetch user role if not cached and not in auto-refresh mode
                if (!localStorage.getItem('user_role') && !showLoadingIndicator) {
                    try {
                        const userResponse = await fetch('/api/user/profile', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            userRole = userData.role || 'user';
                            isAdmin = userRole === 'admin';
                            localStorage.setItem('user_role', userRole);
                        }
                    } catch (error) {
                        console.warn('Could not fetch user role, defaulting to user');
                    }
                }
                
                // Show loading indicator immediately for better UX
                const dropdownContainer = document.getElementById('user-messages-list');
                if (dropdownContainer) {
                    dropdownContainer.innerHTML = `
                        <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="text-muted ms-2">Loading messages...</small>
                        </div>
                    `;
                }
                
                // Use appropriate endpoint based on user role
                const endpoint = isAdmin ? '/api/admin/messages' : '/api/messages';
                console.log('Making API call to:', endpoint);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Messages loaded successfully:', data);
                    try {
                        displayUserMessages(data);
                        updateUnreadCount(data.unread_count);
                        displayDropdownMessages(data);
                        console.log('Messages displayed successfully');
                    } catch (displayError) {
                        console.error('Error displaying messages:', displayError);
                        // Show error in dropdown
                        const dropdownContainer = document.getElementById('user-messages-list');
                        if (dropdownContainer) {
                            dropdownContainer.innerHTML = '<div class="text-center py-3"><p class="text-muted text-danger">Error loading messages</p></div>';
                        }
                    }
                } else {
                    const error = await response.json();
                    console.error('Messages API error:', response.status, error);
                    
                    // Handle specific error cases
                    if (response.status === 401) {
                        // Token expired, redirect to login
                        localStorage.removeItem('auth_token');
                        window.location.href = '/login';
                        return;
                    }
                    
                    if (showLoadingIndicator) {
                        // Don't show error notification for auto-refresh failures
                        console.warn('Auto-refresh failed:', error.detail);
                    } else {
                        showNotification(`Failed to load messages: ${error.detail}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('Error loading user messages:', error);
                
                // Handle network errors
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    console.warn('Network error during message refresh');
                    if (!showLoadingIndicator) {
                        showNotification('Network error. Please check your connection.', 'error');
                    }
                    return;
                }
                
                if (showLoadingIndicator) {
                    // Don't show error notification for auto-refresh network failures
                    console.warn('Auto-refresh network error:', error.message);
                } else {
                    showNotification('Failed to load messages. Please try again.', 'error');
                }
            } finally {
                isLoadingMessages = false;
            }
        }
        
        function displayDropdownMessages(data) {
            const dropdownContainer = document.getElementById('user-messages-list');
            const messageCountBadge = document.getElementById('message-count-badge');
            
            // Safety check for data structure
            if (!data || !data.received_messages) {
                if (messageCountBadge) messageCountBadge.style.display = 'none';
                if (dropdownContainer) dropdownContainer.innerHTML = '<div class="text-center py-3"><p class="text-muted">No messages available</p></div>';
                return;
            }
            
            if (data.received_messages && data.received_messages.length > 0) {
                // Show unread count badge
                const unreadCount = data.received_messages.filter(msg => msg.status === 'unread').length;
                if (unreadCount > 0) {
                    messageCountBadge.textContent = unreadCount;
                    messageCountBadge.style.display = 'block';
                } else {
                    messageCountBadge.style.display = 'none';
                }
                
                // Display recent messages (max 3)
                const recentMessages = data.received_messages.slice(0, 3);
                dropdownContainer.innerHTML = recentMessages.map(msg => `
                    <div class="d-flex align-items-start mb-2 p-2 ${msg.status === 'unread' ? 'bg-light border-start border-primary border-3' : ''}" style="border-radius: 5px;">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <strong class="text-truncate" style="max-width: 150px;" title="${msg.subject}">${msg.subject}</strong>
                                ${msg.status === 'unread' ? '<span class="badge bg-primary ms-1">New</span>' : ''}
                            </div>
                            <p class="mb-1 text-muted small text-truncate" style="max-width: 200px;" title="${msg.message}">${msg.message}</p>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleDateString()}</small>
                        </div>
                    </div>
                `).join('');
                
                // Add "View All" link if there are more than 3 messages
                if (data.received_messages.length > 3) {
                    dropdownContainer.innerHTML += `
                        <div class="text-center mt-2">
                            <small class="text-muted">+${data.received_messages.length - 3} more messages</small>
                        </div>
                    `;
                }
            } else {
                messageCountBadge.style.display = 'none';
                dropdownContainer.innerHTML = `
                    <div class="text-center py-3">
                        <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0 mt-2">No messages from admin</p>
                    </div>
                `;
            }
        }
        
        function displayUserMessages(data) {
            // Show/hide actions bar based on whether there are messages
            const actionsBar = document.getElementById('message-actions-bar');
            const hasMessages = (data.received_messages && data.received_messages.length > 0) || 
                               (data.sent_messages && data.sent_messages.length > 0);
            
            if (hasMessages) {
                actionsBar.style.display = 'flex';
            } else {
                actionsBar.style.display = 'none';
            }
            
            // Reset selection state
            resetMessageSelection();
            
            // Display received messages
            const receivedContainer = document.getElementById('received-messages');
            const receivedCount = document.getElementById('received-count');
            
            if (data.received_messages && data.received_messages.length > 0) {
                receivedCount.textContent = data.received_messages.length;
                receivedContainer.innerHTML = data.received_messages.map(msg => `
                    <div class="card mb-3 ${msg.status === 'unread' ? 'border-primary' : ''}" data-message-id="${msg.id}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                    <input class="form-check-input message-checkbox" type="checkbox" value="${msg.id}" onchange="updateMessageSelection()">
                                </div>
                                <div>
                                    <strong>${msg.subject}</strong>
                                    <span class="badge ${msg.status === 'unread' ? 'bg-primary' : 'bg-secondary'} ms-2">${msg.status}</span>
                                </div>
                            </div>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${msg.message}</p>
                            <small class="text-muted">From: ${msg.from_username}</small>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-outline-success me-2" onclick="replyToMessage('${msg.from_username}', 'Re: ${msg.subject}')">
                                <i class="bi bi-reply me-1"></i>Reply
                            </button>
                            <button class="btn btn-sm btn-outline-danger me-2" onclick="deleteSingleMessage('${msg.id}')">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            ${msg.status === 'unread' ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="markMessageAsRead('${msg.id}')">
                                <i class="bi bi-check-lg me-1"></i>Mark as Read
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                receivedCount.textContent = '0';
                receivedContainer.innerHTML = '<div class="text-center py-4"><p class="text-muted">No received messages</p></div>';
            }
            
            // Display sent messages
            const sentContainer = document.getElementById('sent-messages');
            const sentCount = document.getElementById('sent-count');
            
            if (data.sent_messages && data.sent_messages.length > 0) {
                sentCount.textContent = data.sent_messages.length;
                sentContainer.innerHTML = data.sent_messages.map(msg => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                    <input class="form-check-input message-checkbox" type="checkbox" value="${msg.id}" onchange="updateMessageSelection()">
                                </div>
                                <div>
                                    <strong>${msg.subject}</strong>
                                    <span class="badge bg-info ms-2">Sent</span>
                                </div>
                            </div>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${msg.message}</p>
                            <small class="text-muted">To: ${msg.to_username}</small>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSingleMessage('${msg.id}')">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                sentCount.textContent = '0';
                sentContainer.innerHTML = '<div class="text-center py-4"><p class="text-muted">No sent messages</p></div>';
            }
        }
        
        // Message selection and deletion functions
        function resetMessageSelection() {
            document.getElementById('select-all-messages').checked = false;
            document.getElementById('selected-count').textContent = '0 selected';
            document.getElementById('delete-selected-btn').disabled = true;
        }
        
        function updateMessageSelection() {
            const checkboxes = document.querySelectorAll('.message-checkbox');
            const checkedBoxes = document.querySelectorAll('.message-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all-messages');
            const selectedCount = document.getElementById('selected-count');
            const deleteBtn = document.getElementById('delete-selected-btn');
            
            // Update selected count
            selectedCount.textContent = `${checkedBoxes.length} selected`;
            
            // Enable/disable delete button
            deleteBtn.disabled = checkedBoxes.length === 0;
            
            // Update select all checkbox state
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        function toggleAllMessages() {
            const selectAllCheckbox = document.getElementById('select-all-messages');
            const checkboxes = document.querySelectorAll('.message-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateMessageSelection();
        }
        
        async function deleteSelectedMessages() {
            const checkedBoxes = document.querySelectorAll('.message-checkbox:checked');
            const messageIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
            
            if (messageIds.length === 0) {
                showNotification('Please select messages to delete.', 'warning');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete ${messageIds.length} message(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to delete messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/messages/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message_ids: messageIds,
                        type: 'received'  // Default to received, will be handled by backend
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Successfully deleted ${result.deleted_count} message(s).`, 'success');
                    
                    // Reload messages
                    loadUserMessages();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to delete messages: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error deleting messages:', error);
                showNotification('Failed to delete messages. Please try again.', 'error');
            }
        }
        
        async function markMessageAsRead(messageId) {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to mark messages as read.', 'error');
                    return;
                }
                
                const response = await fetch(`/api/messages/${messageId}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Message marked as read', 'success');
                    // Update UI immediately without reloading all messages
                    updateMessageStatusInUI(messageId, 'read');
                    // Update unread count
                    updateUnreadCountFromUI();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to mark message as read: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error marking message as read:', error);
                showNotification('Failed to mark message as read. Please try again.', 'error');
            }
        }
        
        async function deleteSingleMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to delete messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/messages/delete', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message_ids: [messageId],
                        type: 'received'  // Default to received, will be handled by backend
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Message deleted successfully', 'success');
                    // Reload messages to update the display
                    loadUserMessages();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to delete message: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Failed to delete message. Please try again.', 'error');
            }
        }
        
        function replyToMessage(username, subject) {
            // Create a simple modal to send reply
            const modalContent = `
                <div class="modal fade" id="replyMessageModal" tabindex="-1" aria-labelledby="replyMessageModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="replyMessageModalLabel">
                                    <i class="bi bi-reply me-2"></i>Reply to ${username}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="replyMessageForm">
                                    <div class="mb-3">
                                        <label for="replySubject" class="form-label">Subject</label>
                                        <input type="text" class="form-control" id="replySubject" value="${subject}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replyContent" class="form-label">Message</label>
                                        <textarea class="form-control" id="replyContent" rows="4" placeholder="Enter your reply" required></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitReplyMessage('${username}')">
                                    <i class="bi bi-send me-1"></i>Send Reply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('replyMessageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('replyMessageModal'));
            modal.show();
        }
        
        async function submitReplyMessage(username) {
            const subject = document.getElementById('replySubject').value.trim();
            const message = document.getElementById('replyContent').value.trim();
            
            if (!subject || !message) {
                showNotification('Please fill in both subject and message', 'warning');
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to_username: username,
                        subject: subject,
                        message: message
                    })
                });
                
                if (response.ok) {
                    showNotification('Reply sent successfully!', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('replyMessageModal'));
                    modal.hide();
                    // Clear form
                    document.getElementById('replyContent').value = '';
                    // Reload messages to show the sent message
                    loadUserMessages();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send reply: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                showNotification('Failed to send reply. Please try again.', 'error');
            }
        }
        
        function updateUnreadCount(count) {
            const unreadBadge = document.getElementById('unread-message-count');
            if (count > 0) {
                unreadBadge.textContent = count;
                unreadBadge.style.display = 'inline';
            } else {
                unreadBadge.style.display = 'none';
            }
        }
        
        function updateMessageStatusInUI(messageId, newStatus) {
            // Update message status in all message containers
            const messageElements = document.querySelectorAll(`[data-message-id="${messageId}"]`);
            messageElements.forEach(element => {
                // Update status badge
                const statusBadge = element.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.textContent = newStatus;
                    statusBadge.className = `badge ${newStatus === 'unread' ? 'bg-primary' : 'bg-secondary'} ms-2`;
                }
                
                // Update card border
                const card = element.closest('.card');
                if (card) {
                    if (newStatus === 'unread') {
                        card.classList.add('border-primary');
                    } else {
                        card.classList.remove('border-primary');
                    }
                }
                
                // Hide/show mark as read button
                const markAsReadButton = element.querySelector('button[onclick*="markMessageAsRead"]');
                if (markAsReadButton) {
                    if (newStatus === 'unread') {
                        markAsReadButton.style.display = 'inline-block';
                    } else {
                        markAsReadButton.style.display = 'none';
                    }
                }
            });
        }
        
        function updateUnreadCountFromUI() {
            // Count unread messages from the current UI
            const unreadElements = document.querySelectorAll('.badge.bg-primary');
            const unreadCount = unreadElements.length;
            updateUnreadCount(unreadCount);
        }
        
        // Load unread count on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUnreadCount();
            checkAdminRole();
        });
        
        async function loadUnreadCount() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) return;
                
                const response = await fetch('/api/messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateUnreadCount(data.unread_count);
                }
                
            } catch (error) {
                console.error('Error loading unread count:', error);
            }
        }
        
        // Admin Functions
        
        async function checkAdminRole() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) return;
                
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.role === 'admin') {
                        document.getElementById('admin-message-section').style.display = 'block';
                        loadAdminMessageCount();
                    }
                }
                
            } catch (error) {
                console.error('Error checking admin role:', error);
            }
        }
        
        async function loadAdminMessageCount() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) return;
                
                const response = await fetch('/api/admin/messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const adminBadge = document.getElementById('admin-message-count');
                    adminBadge.textContent = data.total_count;
                    if (data.total_count > 0) {
                        adminBadge.style.display = 'inline';
                    } else {
                        adminBadge.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error loading admin message count:', error);
            }
        }
        
        function showAdminMessagesModal() {
            const modal = new bootstrap.Modal(document.getElementById('adminMessagesModal'));
            modal.show();
            loadAdminMessages();
        }
        
        function showAdminSentMessagesModal() {
            const modal = new bootstrap.Modal(document.getElementById('adminSentMessagesModal'));
            modal.show();
            loadAdminSentMessages();
        }
        
        function showSendMessageModal() {
            const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
            modal.show();
            loadUsersForMessaging();
            
            // Clear form
            document.getElementById('send-subject').value = '';
            document.getElementById('send-message').value = '';
            document.getElementById('send-char-count').textContent = '0';
        }
        
        // Character count for send message
        document.getElementById('send-message').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('send-char-count').textContent = count;
            
            if (count > 1000) {
                this.value = this.value.substring(0, 1000);
                document.getElementById('send-char-count').textContent = '1000';
            }
        });
        
        async function loadAdminMessages() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to view admin messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/admin/messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAdminMessages(data.received_messages);
                } else {
                    const error = await response.json();
                    showNotification(`Failed to load admin messages: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error loading admin messages:', error);
                showNotification('Failed to load admin messages. Please try again.', 'error');
            }
        }
        
        async function loadAdminSentMessages() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to view sent messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/admin/messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAdminSentMessages(data.sent_messages);
                } else {
                    const error = await response.json();
                    showNotification(`Failed to load sent messages: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error loading admin sent messages:', error);
                showNotification('Failed to load sent messages. Please try again.', 'error');
            }
        }
        
        function displayAdminMessages(messages) {
            const container = document.getElementById('admin-messages-container');
            
            // Safety check for messages array
            if (!messages || !Array.isArray(messages)) {
                console.error('Invalid messages data in displayAdminMessages:', messages);
                if (container) {
                    container.innerHTML = '<div class="text-center py-4"><p class="text-muted">Error loading messages</p></div>';
                }
                return;
            }
            
            if (messages && messages.length > 0) {
                container.innerHTML = messages.map(msg => `
                    <div class="card mb-3 ${msg.status === 'unread' ? 'border-warning' : ''}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${msg.subject}</strong>
                                <span class="badge ${msg.status === 'unread' ? 'bg-warning' : 'bg-secondary'} ms-2">${msg.status}</span>
                                <span class="badge bg-info ms-2">From: ${msg.from_username}</span>
                            </div>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${msg.message}</p>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="replyToUser('${msg.from_username}', 'Re: ${msg.subject}')">
                                <i class="bi bi-reply me-1"></i>Reply
                            </button>
                            ${msg.status === 'unread' ? `
                            <button class="btn btn-sm btn-outline-success" onclick="markAdminMessageAsRead('${msg.id}')">
                                <i class="bi bi-check-lg me-1"></i>Mark as Read
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-center py-4"><p class="text-muted">No messages from users</p></div>';
            }
        }
        
        function displayAdminSentMessages(messages) {
            const container = document.getElementById('admin-sent-messages-container');
            
            // Safety check for messages array
            if (!messages || !Array.isArray(messages)) {
                console.error('Invalid messages data in displayAdminSentMessages:', messages);
                if (container) {
                    container.innerHTML = '<div class="text-center py-4"><p class="text-muted">Error loading sent messages</p></div>';
                }
                return;
            }
            
            if (messages && messages.length > 0) {
                container.innerHTML = messages.map(msg => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${msg.subject}</strong>
                                <span class="badge bg-success ms-2">Sent</span>
                                <span class="badge bg-info ms-2">To: ${msg.to_username}</span>
                            </div>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${msg.message}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-center py-4"><p class="text-muted">No sent messages</p></div>';
            }
        }
        
        async function loadUsersForMessaging() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to send messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/admin/users/messaging', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('send-to-username');
                    select.innerHTML = '<option value="">Choose a user...</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.username} (${user.first_name} ${user.last_name})`;
                        select.appendChild(option);
                    });
                } else {
                    const error = await response.json();
                    showNotification(`Failed to load users: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error loading users for messaging:', error);
                showNotification('Failed to load users. Please try again.', 'error');
            }
        }
        
        async function sendMessageToUser() {
            try {
                const toUsername = document.getElementById('send-to-username').value;
                const subject = document.getElementById('send-subject').value.trim();
                const message = document.getElementById('send-message').value.trim();
                
                if (!toUsername || !subject || !message) {
                    showNotification('Please fill in all fields.', 'error');
                    return;
                }
                
                if (message.length > 1000) {
                    showNotification('Message is too long. Maximum 1000 characters allowed.', 'error');
                    return;
                }
                
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to send messages.', 'error');
                    return;
                }
                
                const response = await fetch('/api/admin/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        to_username: toUsername,
                        subject: subject,
                        message: message
                    })
                });
                
                if (response.ok) {
                    showNotification(`Message sent to ${toUsername} successfully!`, 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
                    modal.hide();
                    
                    // Clear form
                    document.getElementById('send-to-username').value = '';
                    document.getElementById('send-subject').value = '';
                    document.getElementById('send-message').value = '';
                    document.getElementById('send-char-count').textContent = '0';
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send message: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending message to user:', error);
                showNotification('Failed to send message. Please try again.', 'error');
            }
        }
        
        function replyToUser(username, subject) {
            // Close admin messages modal
            const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminMessagesModal'));
            adminModal.hide();
            
            // Open send message modal
            const sendModal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
            sendModal.show();
            
            // Pre-fill the form
            document.getElementById('send-to-username').value = username;
            document.getElementById('send-subject').value = subject;
            document.getElementById('send-message').value = '';
            document.getElementById('send-char-count').textContent = '0';
            
            // Load users to ensure the select is populated
            loadUsersForMessaging();
        }
        
        async function viewUserMessages(username) {
            try {
                console.log(`Viewing messages from user: ${username}`);
                
                // Open the admin messages modal
                const modal = new bootstrap.Modal(document.getElementById('adminMessagesModal'));
                modal.show();
                
                // Load admin messages and filter by user if needed
                await loadAdminMessages();
                
                // Show a notification about which user's messages we're viewing
                showNotification(`Viewing messages from user: ${username}`, 'info');
                
                // Optionally, we could add filtering logic here to highlight messages from this specific user
                // For now, we'll just open the general admin messages modal
                
            } catch (error) {
                console.error(`Error viewing messages from user ${username}:`, error);
                showNotification(`Failed to view messages from ${username}`, 'error');
            }
        }
        
        async function markAdminMessageAsRead(messageId) {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to mark messages as read.', 'error');
                    return;
                }
                
                const response = await fetch(`/api/messages/${messageId}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Message marked as read', 'success');
                    // Reload admin messages
                    loadAdminMessages();
                    // Update admin message count
                    loadAdminMessageCount();
                } else {
                    const error = await response.json();
                    showNotification(`Failed to mark message as read: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Error marking admin message as read:', error);
                showNotification('Failed to mark message as read. Please try again.', 'error');
            }
        }
    </script>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userProfileModalLabel">
                        <i class="bi bi-person-circle me-2"></i>User Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userProfileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="profile-username" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-role" class="form-label">Role</label>
                                    <input type="text" class="form-control" id="profile-role" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-first-name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="profile-first-name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-last-name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="profile-last-name">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profile-email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="profile-phone">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="profile-additional-info" class="form-label">Additional Information</label>
                            <textarea class="form-control" id="profile-additional-info" rows="3"></textarea>
                        </div>
                        
                        <!-- Telegram Connection Section -->
                        <hr class="my-4">
                        <h6 class="mb-3">
                            <i class="bi bi-telegram me-2"></i>Telegram Notifications
                        </h6>
                        <div id="telegram-connection-status" class="mb-3">
                            <!-- Telegram connection status will be loaded here -->
                        </div>
                        <div id="telegram-connection-form">
                            <div class="mb-3">
                                <label for="telegram-chat-id" class="form-label">Telegram Chat ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="telegram-chat-id" placeholder="Enter your Telegram Chat ID">
                                    <button class="btn btn-outline-secondary" type="button" onclick="showTelegramInstructions()">
                                        <i class="bi bi-question-circle me-1"></i>How to get Chat ID?
                                    </button>
                                </div>
                                <div class="form-text">Enter your Telegram Chat ID to receive trading notifications.</div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary" onclick="connectTelegram()">
                                    <i class="bi bi-telegram me-1"></i>Connect Telegram
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contact Admin Section -->
                        <hr class="my-4">
                        <h6 class="mb-3">
                            <i class="bi bi-envelope me-2"></i>Contact Admin
                        </h6>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="showContactAdminModal()">
                                <i class="bi bi-envelope me-1"></i>Send Message to Admin
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2" onclick="showMessagesModal()">
                                <i class="bi bi-chat-dots me-1"></i>My Messages
                                <span id="unread-message-count" class="badge bg-danger ms-1" style="display: none;">0</span>
                            </button>
                        </div>
                        
                        <!-- Admin Message Management Section (Admin Only) -->
                        <div id="admin-message-section" style="display: none;">
                            <hr class="my-4">
                            <h6 class="mb-3">
                                <i class="bi bi-gear me-2"></i>Admin Message Management
                            </h6>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-warning" onclick="showAdminMessagesModal()">
                                    <i class="bi bi-inbox me-1"></i>View All Messages
                                    <span id="admin-message-count" class="badge bg-warning ms-1">0</span>
                                </button>
                                <button type="button" class="btn btn-outline-info ms-2" onclick="showAdminSentMessagesModal()">
                                    <i class="bi bi-send me-1"></i>View Sent Messages
                                </button>
                                <button type="button" class="btn btn-outline-success ms-2" onclick="showSendMessageModal()">
                                    <i class="bi bi-send me-1"></i>Send Message to User
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-created-at" class="form-label">Created At</label>
                                    <input type="text" class="form-control" id="profile-created-at" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-last-login" class="form-label">Last Login</label>
                                    <input type="text" class="form-control" id="profile-last-login" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-status" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="profile-status" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-activation" class="form-label">Activation Period</label>
                                    <input type="text" class="form-control" id="profile-activation" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateUserProfile()">
                        <i class="bi bi-check-lg me-1"></i>Update Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="bi bi-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new-password" required minlength="6">
                            <div class="form-text">Password must be at least 6 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm-password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">
                        <i class="bi bi-check-lg me-1"></i>Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Admin Modal -->
    <div class="modal fade" id="contactAdminModal" tabindex="-1" aria-labelledby="contactAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactAdminModalLabel">
                        <i class="bi bi-envelope me-2"></i>Contact Admin
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactAdminForm">
                        <div class="mb-3">
                            <label for="contact-subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="contact-subject" required maxlength="100" placeholder="Enter message subject">
                        </div>
                        <div class="mb-3">
                            <label for="contact-message" class="form-label">Message</label>
                            <textarea class="form-control" id="contact-message" rows="6" required maxlength="1000" placeholder="Enter your message to admin..."></textarea>
                            <div class="form-text">Maximum 1000 characters. <span id="contact-char-count">0</span>/1000</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessageToAdmin()">
                        <i class="bi bi-send me-1"></i>Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Sent Messages Modal -->
    <div class="modal fade" id="adminSentMessagesModal" tabindex="-1" aria-labelledby="adminSentMessagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminSentMessagesModalLabel">
                        <i class="bi bi-send me-2"></i>Sent Messages
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="admin-sent-messages-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading sent messages...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="modal fade" id="messagesModal" tabindex="-1" aria-labelledby="messagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messagesModalLabel">
                        <i class="bi bi-chat-dots me-2"></i>My Messages
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Message Actions Bar -->
                    <div class="d-flex justify-content-between align-items-center mb-3" id="message-actions-bar" style="display: none !important;">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="select-all-messages" onchange="toggleAllMessages()">
                                <label class="form-check-label" for="select-all-messages">
                                    Select All
                                </label>
                            </div>
                            <span id="selected-count" class="text-muted">0 selected</span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger btn-sm" id="delete-selected-btn" onclick="deleteSelectedMessages()" disabled>
                                <i class="bi bi-trash me-1"></i>Delete Selected
                            </button>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs" id="messagesTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab">
                                <i class="bi bi-inbox me-1"></i>Received
                                <span id="received-count" class="badge bg-primary ms-1">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">
                                <i class="bi bi-send me-1"></i>Sent
                                <span id="sent-count" class="badge bg-secondary ms-1">0</span>
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="messagesTabContent">
                        <div class="tab-pane fade show active" id="received" role="tabpanel">
                            <div id="received-messages" class="mt-3">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading messages...</p>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="sent" role="tabpanel">
                            <div id="sent-messages" class="mt-3">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading messages...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Messages Modal -->
    <div class="modal fade" id="adminMessagesModal" tabindex="-1" aria-labelledby="adminMessagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminMessagesModalLabel">
                        <i class="bi bi-inbox me-2"></i>All User Messages
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="admin-messages-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading messages...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Message to User Modal -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendMessageModalLabel">
                        <i class="bi bi-send me-2"></i>Send Message to User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sendMessageForm">
                        <div class="mb-3">
                            <label for="send-to-username" class="form-label">Select User</label>
                            <select class="form-select" id="send-to-username" required>
                                <option value="">Choose a user...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="send-subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="send-subject" required maxlength="100" placeholder="Enter message subject">
                        </div>
                        <div class="mb-3">
                            <label for="send-message" class="form-label">Message</label>
                            <textarea class="form-control" id="send-message" rows="6" required maxlength="1000" placeholder="Enter your message..."></textarea>
                            <div class="form-text">Maximum 1000 characters. <span id="send-char-count">0</span>/1000</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessageToUser()">
                        <i class="bi bi-send me-1"></i>Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
